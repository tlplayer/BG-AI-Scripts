<<<<<<< HEAD
// ======================================================
// GLOBALS
// ======================================================

// Set a timer for short-duration buffs
// This section sets a global timer to track the duration of short-duration buffs.
// The timer is set to two rounds initially and updated to one round when a hotkey is pressed.
IF
    ActuallyInCombat()
    GlobalTimerExpired("SHORT_BUFF","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,1)
        SetGlobalTimer("SHORT_BUFF","LOCALS",ONE_TURN)
END

IF
    CheckStatGT(Myself,0,WIZARD_IMPROVED_ALACRITY)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,2)
        SetGlobalTimer("WIZARD_CAST","LOCALS",0)
END

// This section sets a global timer for casting area-of-effect spells if there are more than 3 enemies nearby.
IF
    Delay(18)
    OR(4)
        Exists([EVILCUTOFF])
        AreaCheck("OH8200")
        AreaCheck("OH8300")
        AreaCheck("OH8400")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,3)
        SetGlobalTimer("SUMMON","LOCALS",ONE_TURN)
END

IF
    HotKey(K)  // Detect pressing of the 'B' key
THEN
    RESPONSE #100
        DisplayStringHead(Myself,4)
        SetGlobalTimer("SUMMON","LOCALS",ONE_TURN)  // Set the timer to one round
END

IF
    HotKey(B)  // Detect pressing of the 'B' key
THEN
    RESPONSE #100
        DisplayStringHead(Myself,5)
        SetGlobalTimer("SHORT_BUFF","LOCALS",ONE_TURN)  // Set the timer to one round
END

// Set a timer for casting area-of-effect spells
// This section sets a global timer for casting area-of-effect spells if there are more than 3 enemies nearby.
IF
    NumCreatureGT([ENEMY],3)
    !Range(NearestEnemyOf(NearestEnemyOf(Myself)),12)
    Range(NearestEnemyOf(NearestEnemyOf(Myself)),30)
    !GlobalTimerNotExpired("AOE_SPELLS","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,6)
        SetGlobalTimer("AOE_SPELLS","LOCALS",THREE_ROUNDS)
END

// ======================================================
// Black Pits Area Check
// ======================================================

//If I'm in the blackpits area, I cannot cast buffs/spells so just continue.
IF
    ActionListEmpty()
    AreaCheck("OH8100")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,7)
        Continue()
        Wait(10)
END

// ======================================================
// ENEMY DETECTION
// ======================================================
/*
This section of the code is for determining which enemy is currently being faced. 
For each enemy type:
    set timer for enemy type

    Subsequent logic blocks will check these timers in conjuction or individually
    taking the resulting intelligent actions. 

    Example: facing fire elementals, do not use fire spells, 
    do cast fire protection spells if my resistance is low, 
    buff allies for fire protection if they are low. 
    Use specific items like charm fire elemental if the elemental is evil. 
*/


// See Fire Type Elemental with high resistance, don't use fire spells.
// General form [EA.GENERAL.RACE.CLASS.SPECIFIC.GENDER.ALIGN].
IF
    OR(2)
        Detect([ENEMY.0.0.ELEMENTAL_FIRE.0])
        Detect([ENEMY.0.0.GREY_OOZE])
    !GlobalTimerNotExpired("FIRE_ENEMIES","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,8)
        SetGlobalTimer("FIRE_ENEMIES","LOCALS",ONE_TURN)
END

IF
    ActuallyInCombat()
    OR(6)
        See(NearestEnemyOfType([ENEMY.0.0.MAGE_ALL]))
        See(NearestEnemyOfType([ENEMY.0.0.CLERIC_ALL]))
        See(NearestEnemyOfType([ENEMY.0.0.BARD_ALL]))
        See(NearestEnemyOfType([ENEMY.0.0.DRUID_ALL]))
        See(NearestEnemyOfType([ENEMY.0.0.SORCERER]))
        See(NearestEnemyOfType([ENEMY.0.0.RAKSHASA]))
    GlobalTimerExpired("CASTER_ENEMY","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,9)
        SetGlobalTimer("CASTER_ENEMY","LOCALS",ONE_TURN)
END

// Detect Troll-type enemies, prepare to use anti-Troll strategies.
IF
    Detect([ENEMY.0.0.TROLL.0])
    !GlobalTimerNotExpired("TROLL_ENEMIES","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,10)
        SetGlobalTimer("TROLL_ENEMIES","LOCALS",ONE_TURN)
END

// Detect Troll-type enemies, prepare to use anti-Troll strategies.
IF
    Detect([ENEMY.0.0.GREEN_SLIME])
    !GlobalTimerNotExpired("SLIME_ENEMIES","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,11)
        SetGlobalTimer("SLIME_ENEMIES","LOCALS",ONE_TURN)
END


// Detect Troll-type enemies, prepare to use anti-Troll strategies.
IF
    OR(2)
        Detect([ENEMY.0.0.UMBERHULK.0])
        Detect([ENEMY.0.0.MIND_FLAYER.0])
        Detect([ENEMY.0.0.MIND_FLAYER.0])
        Detect([ENEMY.0.0.MIND_FLAYER.0])
    !GlobalTimerNotExpired("PSYCHIC_ENEMIES","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,12)
        SetGlobalTimer("PSYCHIC_ENEMIES","LOCALS",ONE_TURN)
END


// ======================================================
// CHECK FOR CROWD CONTROLLED PARTY MEMBERS
// ======================================================

// Check for crowd-controlled party members
// This section randomly walks if any party member is affected by crowd control spells or if the wizard is helpless.
IF
    ActionListEmpty()
    ActuallyInCombat()
    CheckStatLT(Myself,1,CLERIC_FREE_ACTION) // Check if party is being crowd-controlled
    CheckStatLT(Myself,1,MINORGLOBE)
    CheckStatLT(Myself,1,SHIELDGLOBE)
    CheckStatGT(Myself,2,SAVEVSSPELL) //and I got a reasonable chance of failing a save throw (25%+)
    OR(8)
        CheckStat([PC],1,WEB)
        CheckStat([PC],1,GREASE)
        StateCheck([PC],STATE_HELPLESS) // Check if the wizard is helpless
        SpellCast([ENEMY],WIZARD_WEB)  // SPWI215.SPL (Web)
        SpellCast([ENEMY.0.0.0],WIZARD_INCENDIARY_CLOUD)  // SPWI810.SPL (Incendiary Cloud)
        SpellCast([ENEMY.0.0.0],WIZARD_STINKING_CLOUD)  // SPWI213.SPL (Stinking Cloud)
        SpellCast([ENEMY.0.0.0],WIZARD_CLOUDKILL)  // SPWI502.SPL (Cloudkill)
        SpellCast([ENEMY.0.0.0],WIZARD_DEATH_FOG)  // SPWI614.SPL (Death Fog)
    See([ENEMY])
THEN
    RESPONSE #100
        DisplayStringHead(Myself,13)
        SetGlobalTimer("USE_RANGE","LOCALS",ONE_TURN)
        RunAwayFrom(LastSeenBy(Myself),16)
        Continue()
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    CheckStatLT(Myself,1,CLERIC_FREE_ACTION) // Check if party is being crowd-controlled
    CheckStatLT(Myself,1,MINORGLOBE)
    CheckStatLT(Myself,1,SHIELDGLOBE)
    CheckStatGT(Myself,2,SAVEVSSPELL) //and I got a reasonable chance of failing a save throw (25%+)
    OR(8)
        CheckStat([PC],1,WEB)
        CheckStat([PC],1,GREASE)
        StateCheck([PC],STATE_HELPLESS) // Check if the wizard is helpless
        SpellCast([ENEMY],WIZARD_WEB)  // SPWI215.SPL (Web)
        SpellCast([ENEMY.0.0.0],WIZARD_INCENDIARY_CLOUD)  // SPWI810.SPL (Incendiary Cloud)
        SpellCast([ENEMY.0.0.0],WIZARD_STINKING_CLOUD)  // SPWI213.SPL (Stinking Cloud)
        SpellCast([ENEMY.0.0.0],WIZARD_CLOUDKILL)  // SPWI502.SPL (Cloudkill)
        SpellCast([ENEMY.0.0.0],WIZARD_DEATH_FOG)  // SPWI614.SPL (Death Fog)
    See([ENEMY])
THEN
    RESPONSE #100
        DisplayStringHead(Myself,14)
        SetGlobalTimer("USE_RANGE","LOCALS",ONE_TURN)
        RunAwayFrom(LastSeenBy(Myself),16)
        Continue()
END


// Cast Zone of Sweet Air if affected by Stinking Cloud
// This section casts Zone of Sweet Air if the wizard or party members are affected by Stinking Cloud.
IF
    OR(4)
        SpellCast([ENEMY.0.0.0],WIZARD_INCENDIARY_CLOUD)  // SPWI810.SPL (Incendiary Cloud)
        SpellCast([ENEMY.0.0.0],WIZARD_STINKING_CLOUD)  // SPWI213.SPL (Stinking Cloud)
        SpellCast([ENEMY.0.0.0],WIZARD_CLOUDKILL)  // SPWI502.SPL (Cloudkill)
        SpellCast([ENEMY.0.0.0],WIZARD_DEATH_FOG)  // SPWI614.SPL (Death Fog)
    HaveSpell(CLERIC_ZONE_OF_SWEET_AIR)  // SPPR318.SPL (Zone of Sweet Air)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,15)
        Spell(Myself,CLERIC_ZONE_OF_SWEET_AIR)  // Cast Zone of Sweet Air to counteract Stinking Cloud
END


// ======================================================
// Heal SPELLS (CLERIC)
// ======================================================


// Heal Light Wounds
IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],70) // Heal when HP is below 70
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_CURE_LIGHT_WOUNDS)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,16)
        Spell(LastSeenBy(Myself),CLERIC_CURE_LIGHT_WOUNDS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer (adjust as needed)
END

IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],70) // Heal when HP is below 70
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_CURE_MEDIUM_WOUNDS)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,17)
        Spell(LastSeenBy(Myself),CLERIC_CURE_MEDIUM_WOUNDS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer (adjust as needed)
END

IF
    ActionListEmpty()
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    OR(2)
        StateCheck([GOODCUTOFF],STATE_STUNNED)
        CheckStatGT([GOODCUTOFF],0,HELD)
    See([GOODCUTOFF])
    HaveSpell(CLERIC_REMOVE_PARALYSIS)  // SPPR308.SPL (Remove Paralysis)
    !StateCheck(LastSeenBy(Myself),STATE_IMPROVEDINVISIBILITY)
    CheckStat(LastSeenBy(Myself),0,MINORGLOBE)
    !StateCheck(LastSeenBy(Myself),STATE_CONFUSED)
    !StateCheck(LastSeenBy(Myself),STATE_CHARMED)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,18)
        SetInterrupt(FALSE)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
        Spell(LastSeenBy(Myself),CLERIC_REMOVE_PARALYSIS)  // SPPR308.SPL (Remove Paralysis)
        SetInterrupt(TRUE)
END

// Heal Serious Wounds
IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],50) // Heal when HP is below 70
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_CURE_SERIOUS_WOUNDS)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,19)
        Spell(Myself,CLERIC_CURE_SERIOUS_WOUNDS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_CHAOTIC_COMMANDS)  // SPPR303.SPL (Dispel Magic)
    Allegiance(Myself,GOODCUTOFF)
    See([PC])
    OR(2)
        StateCheck(LastSeenBy(Myself),STATE_CHARMED)
        StateCheck(LastSeenBy(Myself),STATE_CONFUSED)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,20)
        Spell(LastSeenBy(Myself),CLERIC_CHAOTIC_COMMANDS)  // SPPR303.SPL (Dispel Magic)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_DISPEL_MAGIC)  // SPPR303.SPL (Dispel Magic)
    Allegiance(Myself,GOODCUTOFF)
    See([PC])
    OR(4)
        StateCheck(LastSeenBy(Myself),STATE_CHARMED)
        StateCheck(LastSeenBy(Myself),STATE_CONFUSED)
        StateCheck(LastSeenBy(Myself),STATE_STUNNED)
        CheckStatGT(LastSeenBy(Myself),0,HELD)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,21)
        Spell(LastSeenBy(Myself),CLERIC_DISPEL_MAGIC)  // SPPR303.SPL (Dispel Magic)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END


IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    OR(3)
        StateCheck([GOODCUTOFF],STATE_STUNNED)
        CheckStatGT([GOODCUTOFF],0,HELD)
        CheckStatGT([PC],0,LEVELDRAIN)
    HaveSpell(CLERIC_RESTORATION)  // 1713 (CLERIC_RESTORATION)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,22)
        Spell(LastSeenBy(Myself),CLERIC_RESTORATION)  // Cast CLERIC_RESTORATION
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    See([PC])
    HaveSpell(CLERIC_LESSER_RESTORATION)  // 1713 (CLERIC_RESTORATION)
    OR(3)
        StateCheck([GOODCUTOFF],STATE_STUNNED)
        CheckStatGT([GOODCUTOFF],0,HELD)
        CheckStatGT([PC],0,LEVELDRAIN)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,23)
        Spell(LastSeenBy(Myself),CLERIC_LESSER_RESTORATION)  // Cast CLERIC_RESTORATION
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// Heal Critical Wounds
IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],50) // Heal when HP is below 20
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_CURE_CRITICAL_WOUNDS)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,24)
        Spell(LastSeenBy(Myself),CLERIC_CURE_CRITICAL_WOUNDS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END

IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],50) // Heal when HP is below 20
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_HEAL)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,25)
        Spell(LastSeenBy(Myself),CLERIC_HEAL)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END

IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],75)
    HaveSpell(PALADIN_LAY_ON_HANDS)  // 4211 (PALADIN_LAY_ON_HANDS)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,26)
        Spell(LastSeenBy(Myself),PALADIN_LAY_ON_HANDS)  // Cast PALADIN_LAY_ON_HANDS
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
//  Heal (WIZARD)
// ======================================================

IF
    ActionListEmpty()
    HaveSpell(WIZARD_REMOVE_MAGIC)  // SPPR303.SPL (Dispel Magic)
    Allegiance(Myself,GOODCUTOFF)
    See([PC])
    OR(4)
        StateCheck(LastSeenBy(Myself),STATE_CHARMED)
        StateCheck(LastSeenBy(Myself),STATE_CONFUSED)
        StateCheck(LastSeenBy(Myself),STATE_STUNNED)
        CheckStatGT(LastSeenBy(Myself),0,HELD)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,27)
        Spell(LastSeenBy(Myself),WIZARD_REMOVE_MAGIC)  // SPPR303.SPL (Dispel Magic)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END

// ======================================================
// Heal ITEMS 
// ======================================================


IF
    ActionListEmpty()
    HPPercentLT(Myself,50)
    PartyHasItem("POTN55")  // Potion of Superior Healing
THEN
    RESPONSE #100
        DisplayStringHead(Myself,28)
        TakePartyItem("POTN55")
        UseItem("POTN55",Myself)  // Potion of Superior Healing
END

IF
    ActionListEmpty()
    HPPercentLT(Myself,50)
    PartyHasItem("POTN52")  // Potion of Superior Healing
THEN
    RESPONSE #100
        DisplayStringHead(Myself,29)
        TakePartyItem("POTN52")
        UseItem("POTN52",Myself)  // Potion of Superior Healing
END

IF
    ActionListEmpty()
    HPPercentLT(Myself,50)
    PartyHasItem("POTN08")  // Potion of Superior Healing
THEN
    RESPONSE #100
        DisplayStringHead(Myself,30)
        TakePartyItem("POTN08")
        UseItem("POTN08",Myself)  // Potion of Superior Healing
END

IF
    ActionListEmpty()
    HPPercentLT(Myself,35)
    !StateCheck(Myself,STATE_INVISIBLE)
    PartyHasItem("POTN10")  // Potion of Invisibility
THEN
    RESPONSE #100
        DisplayStringHead(Myself,31)
        TakePartyItem("POTN10")
        UseItem("POTN10",Myself)  
END

IF
    ActionListEmpty()
    !CheckSpellState(Myself,POTION_OF_CLARITY)
    !ExtendedStateCheck(Myself,STATE_CHAOTIC_COMMANDS)
    CheckStatLT(Myself,1,CLERIC_CHAOTIC_COMMANDS)    
    GlobalTimerNotExpired("PSYCHIC_ENEMIES","LOCALS")
    PartyHasItem("POTN21")  // Potion of Clarity
THEN
    RESPONSE #100
        DisplayStringHead(Myself,32)
        DisplayStringHead(Myself,2796)
        //TakePartyItem("POTN21")
        UseItem("POTN21",Myself)  
END

IF
    ActionListEmpty()
    !CheckSpellState(Myself,FREE_ACTION)
    CheckStatLT(Myself,1,CLERIC_FREE_ACTION)    
    Delay(1000)
    GlobalTimerNotExpired("PSYCHIC_ENEMIES","LOCALS")
    PartyHasItem("POTN45")  // Potion of Freedom
THEN
    RESPONSE #100
        DisplayStringHead(Myself,33)
        DisplayStringHead(Myself,2796)
        //TakePartyItem("POTN45")
        UseItem("POTN45",Myself)  
END

//Poison Management
IF
    StateCheck(Myself,STATE_POISONED)
    HPPercentLT(Myself,76)
    PartyHasItem("POTN20",Myself) // Antidote
THEN
    RESPONSE #100
        DisplayStringHead(Myself,34)
        TakePartyItem("POTN20")
        UseItem("POTN20",Myself) // Antidote
END

IF
    ActionListEmpty()
    StateCheck(Myself,STATE_POISONED)
    HPPercentLT(Myself,76)
    PartyHasItem("POTN17",Myself) // Elixir of Health
THEN
    RESPONSE #100
        DisplayStringHead(Myself,35)
        TakePartyItem("POTN17")
        UseItem("POTN17",Myself) // Elixir of Health
END


// ======================================================
// PENETRATION SPELLS (WIZARD)
// ======================================================

IF
    ActuallyInCombat()
    ActionListEmpty()
    OR(6)
    See([ENEMY.0.0.MAGE_ALL])
    See([ENEMY.0.0.CLERIC_ALL])
    See([ENEMY.0.0.BARD_ALL])
    See([ENEMY.0.0.DRUID_ALL])
    See([ENEMY.0.0.SORCERER])
    See([ENEMY.0.0.RAKSHASA])    
    HaveSpell(WIZARD_SPELL_STRIKE)  
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,36)
        Spell(LastSeenBy(Myself),WIZARD_SPELL_STRIKE)  
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See([ENEMY])
    !StateCheck(LastSeenBy(Myself),STATE_NOT_TARGETABLE)
    !ImmuneToSpellLevel(LastSeenBy(Myself),5)
    OR(5)
        CheckStatGT(LastSeenBy(Myself),0,STONESKINS)
        CheckSpellState(LastSeenBy(Myself),PROTECTION_FROM_MAGICAL_WEAPONS)
        CheckSpellState(LastSeenBy(Myself),MANTLE)
        CheckSpellState(LastSeenBy(Myself),IMPROVED_MANTLE)
        CheckSpellState(LastSeenBy(Myself),ABSOLUTE_IMMUNITY)
    !CheckStatGT(Myself,0,CLERIC_INSECT_PLAGUE)
    !StateCheck(Myself,STATE_SILENCED)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    HaveSpell(WIZARD_BREACH)
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,37)
        SetInterrupt(FALSE)
        Spell(LastSeenBy(Myself),WIZARD_BREACH)  
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
        SetInterrupt(TRUE)
END

IF
    ActuallyInCombat()
    ActionListEmpty()  
    See([ENEMY])
    HaveSpell(WIZARD_GLITTERDUST)  
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,38)
        Spell(LastSeenBy(Myself),WIZARD_GLITTERDUST)  
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    OR(6)
    See([ENEMY.0.0.MAGE_ALL])
    See([ENEMY.0.0.CLERIC_ALL])
    See([ENEMY.0.0.BARD_ALL])
    See([ENEMY.0.0.DRUID_ALL])
    See([ENEMY.0.0.SORCERER])
    See([ENEMY.0.0.RAKSHASA])    
    HaveSpell(WIZARD_PIERCE_MAGIC)  
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,39)
        Spell(LastSeenBy(Myself),WIZARD_PIERCE_MAGIC)  
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    OR(6)
    See([ENEMY.0.0.MAGE_ALL])
    See([ENEMY.0.0.CLERIC_ALL])
    See([ENEMY.0.0.BARD_ALL])
    See([ENEMY.0.0.DRUID_ALL])
    See([ENEMY.0.0.SORCERER])
    See([ENEMY.0.0.RAKSHASA])    
    HaveSpell(WIZARD_WARDING_WHIP)  
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,40)
        Spell(NearestEnemyOf(Myself),WIZARD_WARDING_WHIP)  // Cast WIZARD_WARDING_WHIP
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    OR(6)
    See([ENEMY.0.0.MAGE_ALL])
    See([ENEMY.0.0.CLERIC_ALL])
    See([ENEMY.0.0.BARD_ALL])
    See([ENEMY.0.0.DRUID_ALL])
    See([ENEMY.0.0.SORCERER])
    See([ENEMY.0.0.RAKSHASA])    
    HaveSpell(WIZARD_PIERCE_MAGIC)  // 2608 (WIZARD_PIERCE_MAGIC)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,41)
        Spell(LastSeenBy(Myself),WIZARD_PIERCE_MAGIC)  // Cast WIZARD_PIERCE_MAGIC
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END


// ======================================================
// PENETRATION SPELLS (CLERIC)
// ======================================================

IF
    OR(6)
        See([ENEMY.0.0.MAGE_ALL])
        See([ENEMY.0.0.CLERIC_ALL])
        See([ENEMY.0.0.BARD_ALL])
        See([ENEMY.0.0.DRUID_ALL])
        See([ENEMY.0.0.SORCERER])
        See([ENEMY.0.0.RAKSHASA])
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(CLERIC_DISPEL_MAGIC)  // 1303 (CLERIC_DISPEL_MAGIC)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,42)
        Spell(LastSeenBy(Myself),CLERIC_DISPEL_MAGIC)  // Cast CLERIC_DISPEL_MAGIC
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    OR(6)
        See([ENEMY.0.0.MAGE_ALL])
        See([ENEMY.0.0.CLERIC_ALL])
        See([ENEMY.0.0.BARD_ALL])
        See([ENEMY.0.0.DRUID_ALL])
        See([ENEMY.0.0.SORCERER])
        See([ENEMY.0.0.RAKSHASA])
    HaveSpell(INQUIS_DISPEL_MAGIC)  // 4231 (INQUIS_DISPEL_MAGIC)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,43)
        Spell(LastSeenBy(Myself),INQUIS_DISPEL_MAGIC)  // Cast INQUIS_DISPEL_MAGIC
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    OR(6)
        Gender(LastSeenBy(Myself),ILLUSIONARY)
        SpellCast([ENEMY],WIZARD_PROJECT_IMAGE)  // SPWI703.SPL (Project Image)
        SpellCast([ENEMY],WIZARD_SIMULACRUM)  // SPWI804.SPL (Simulacrum)
        SpellCast([ENEMY],WIZARD_MISLEAD)  // SPWI607.SPL (Mislead)
        StateCheck(LastSeenBy(Myself),STATE_BLUR)
        StateCheck(LastSeenBy(Myself),STATE_MIRRORIMAGE)
    !GlobalTimerNotExpired("TrueSight","LOCALS")
    HaveSpell(INQUIS_TRUE_SIGHT)  // 4232 (INQUIS_TRUE_SIGHT)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,44)
        Spell(Myself,INQUIS_TRUE_SIGHT)  // Cast INQUIS_TRUE_SIGHT
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
        SetGlobalTimer("TrueSight","LOCALS",ONE_ROUND)
END

// ======================================================
// SUMMONING SPELLS (CLERIC)
// ======================================================
// CLERIC_ETHER_GATE
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_ETHER_GATE)
    CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,45)
        Spell(Myself,CLERIC_ETHER_GATE)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_SUMMON_DEVA
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_SUMMON_DEVA)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,46)
        Spell(Myself,CLERIC_SUMMON_DEVA)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(PALADIN_SUMMON_DEVA)  // 4923 (PALADIN_SUMMON_DEVA)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,47)
        Spell(NearestEnemyOf(Myself),PALADIN_SUMMON_DEVA)  // Cast PALADIN_SUMMON_DEVA
        SetGlobalTimer("UNKNOWN_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_SUMMON_FALLEN_DEVA
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_SUMMON_FALLEN_DEVA)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,48)
        Spell(Myself,CLERIC_SUMMON_FALLEN_DEVA)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_CONJURE_FIRE_ELEMENTAL
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_CONJURE_FIRE_ELEMENTAL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,49)
        Spell(Myself,CLERIC_CONJURE_FIRE_ELEMENTAL)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_CONJURE_EARTH_ELEMENTAL
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_CONJURE_EARTH_ELEMENTAL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,50)
        Spell(Myself,CLERIC_CONJURE_EARTH_ELEMENTAL)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_GATE
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    HaveSpell(CLERIC_GATE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,51)
        Spell(Myself,CLERIC_GATE)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END


// CLERIC_ANIMAL_SUMMONING_1
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_ANIMAL_SUMMONING_1)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,52)
        Spell(Myself,CLERIC_ANIMAL_SUMMONING_1)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_CALL_WOODLAND_BEINGS
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_CALL_WOODLAND_BEINGS)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,53)
        Spell(Myself,CLERIC_CALL_WOODLAND_BEINGS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_ANIMAL_SUMMONING_2
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_ANIMAL_SUMMONING_2)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,54)
        Spell(Myself,CLERIC_ANIMAL_SUMMONING_2)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_AERIAL_SERVANT
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_AERIAL_SERVANT)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,55)
        Spell(Myself,CLERIC_AERIAL_SERVANT)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_ANIMAL_SUMMONING_3
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_ANIMAL_SUMMONING_3)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,56)
        Spell(Myself,CLERIC_ANIMAL_SUMMONING_3)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_CONJURE_ANIMALS
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_CONJURE_ANIMALS)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,57)
        Spell(Myself,CLERIC_CONJURE_ANIMALS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_ELEMENTAL_SWARM
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_ELEMENTAL_SWARM)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,58)
        Spell(Myself,CLERIC_ELEMENTAL_SWARM)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_GREATER_ELEMENTAL_SWARM
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_GREATER_ELEMENTAL_SWARM)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,59)
        Spell(Myself,CLERIC_GREATER_ELEMENTAL_SWARM)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// SUMMONING SPELLS (WIZARD)
// ======================================================

IF
    ActionListEmpty()
    HaveSpell(WIZARD_SUMMON_PLANATAR_EVIL)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SUMMON","LOCALS")
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,60)
        Spell(Myself,WIZARD_SUMMON_PLANATAR_EVIL)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_SUMMON_PLANATAR_GOOD)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,61)
        Spell(Myself,WIZARD_SUMMON_PLANATAR_GOOD)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_GATE)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,62)
        Spell(Myself,WIZARD_GATE)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_SUMMON_FIEND)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SUMMON","LOCALS")
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,63)
        Spell(Myself,WIZARD_SUMMON_FIEND)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell( WIZARD_SIMULACRUM)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SUMMON","LOCALS")
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,64)
        Spell(Myself, WIZARD_SIMULACRUM)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END


IF
    ActionListEmpty()
    HaveSpell(WIZARD_SUMMON_DJINNI)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SUMMON","LOCALS")
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,65)
        Spell(Myself,WIZARD_SUMMON_DJINNI)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_SUMMON_HAKEASHAR)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,66)
        Spell(Myself,WIZARD_SUMMON_HAKEASHAR)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_SUMMON_EFREET)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,67)
        Spell(Myself,WIZARD_SUMMON_EFREET)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_MORDENKAINENS_SWORD)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,68)
        Spell(Myself,WIZARD_MORDENKAINENS_SWORD)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_CACOFIEND)  // SPWI615.SPL (Summon Hakeashar)
    CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,69)
        Spell(Myself,WIZARD_CACOFIEND)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END


IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_CARRION)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,70)
        Spell(Myself,WIZARD_CARRION)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_WYVERN_CALL)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,71)
        Spell(Myself,WIZARD_WYVERN_CALL)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_SUMMON_NISHRUU)  // SPWI514.SPL (Summon Nishruu)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,72)
        Spell(Myself,WIZARD_SUMMON_NISHRUU)  // Summon Nishruu to absorb enemy magic
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_MONSTER_SUMMONING_4)  // SPWI620.SPL (Monster Summoning IV)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,73)
        Spell(Myself,WIZARD_MONSTER_SUMMONING_4)  // Summon multiple creatures to aid in combat
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_ANIMATE_DEAD)  // SPWI501.SPL (Animate Dead)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,74)
        Spell(Myself,WIZARD_ANIMATE_DEAD)  // Create undead allies
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_MONSTER_SUMMONING_3)  // SPWI611.SPL (Monster Summoning III)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,75)
        Spell(Myself,WIZARD_MONSTER_SUMMONING_3)  // Summon powerful monsters to assist in combat
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_SPIDER_SPAWN)  // SPWI423.SPL (Spider Spawn)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,76)
        Spell(Myself,WIZARD_SPIDER_SPAWN)  // Summon spiders to aid in combat
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_MONSTER_SUMMONING_2)  // SPWI511.SPL (Monster Summoning II)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,77)
        Spell(Myself,WIZARD_MONSTER_SUMMONING_2)  // Summon stronger monsters to assist in combat
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_MONSTER_SUMMONING_1)  // SPWI103.SPL (Summon Monster I)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,78)
        Spell(Myself,WIZARD_MONSTER_SUMMONING_1)  // Summon a monster to assist in combat
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_FIND_FAMILAR)  // SPWI123.SPL (Find Familiar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    !CheckSpellState(Myself,DEAD_MAGIC_AREA)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,79)
        Spell(Myself,WIZARD_FIND_FAMILAR)  // Summon a familiar to assist
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END



// ======================================================
// Short Duration BUFFS SPELLS (WIZARD)
// ======================================================

IF
    ActionListEmpty()
    HaveSpell(WIZARD_MASS_INVISIBILITY)  // 2721 (WIZARD_MASS_INVISIBILITY)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,80)
        Spell(Myself,WIZARD_MASS_INVISIBILITY)  // Cast WIZARD_MASS_INVISIBILITY
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_MIRROR_IMAGE)  // 2721 (WIZARD_MASS_INVISIBILITY)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,81)
            Spell(Myself,WIZARD_MIRROR_IMAGE)  // Cast WIZARD_MASS_INVISIBILITY
            SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_LIMITED_WISH) 
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,82)
        Spell(Myself,WIZARD_LIMITED_WISH)  // Cast WIZARD_LIMITED_WISH
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    Class(Myself,MAGE_ALL)
    HaveSpell(WIZARD_IMPROVED_ALACRITY)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,83)
        Spell(Myself, WIZARD_IMPROVED_ALACRITY)  // Cast Improved Alacrity
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    HaveSpell(WIZARD_ENERGY_BLADES)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,84)
        Spell(Myself, WIZARD_ENERGY_BLADES)  // Cast Energy Blades
        Continue()
END

//This disables spell casting
IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(WIZARD_SHAPECHANGE)  // 2916 (WIZARD_SHAPECHANGE)
    HaveSpell(WIZARD_TENSERS_TRANSFORMATION)  // 2603 (WIZARD_TENSERS_TRANSFORMATION)
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,85)
            Spell(NearestEnemyOf(Myself),WIZARD_SHAPECHANGE)  // Cast WIZARD_SHAPECHANGE
            Spell(NearestEnemyOf(Myself),WIZARD_TENSERS_TRANSFORMATION)  // Cast WIZARD_TENSERS_TRANSFORMATION
            SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    HaveSpell(WIZARD_MINOR_GLOBE_OF_INVULNERABILITY)  // SPWI604.SPL (Globe of Invulnerability)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,86)
        Spell(Myself,WIZARD_MINOR_GLOBE_OF_INVULNERABILITY)  // Cast Globe of Invulnerability for spell protection
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_GLOBE_OF_INVULNERABILITY)  // 2602 (WIZARD_GLOBE_OF_INVULNERABILITY)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,87)
        Spell(NearestEnemyOf(Myself),WIZARD_GLOBE_OF_INVULNERABILITY)  // Cast WIZARD_GLOBE_OF_INVULNERABILITY
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Haste if conditions are met
IF
    ActionListEmpty()
    HaveSpell(WIZARD_HASTE)  // Ensure the Haste spell is available
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")  // Ensure previous spell cast timer has expired
    !StateCheck(Myself,STATE_HASTED)  // Ensure Haste is not already active
THEN
    RESPONSE #100
        DisplayStringHead(Myself,88)
        Spell(Myself,WIZARD_HASTE)  // Cast Haste on Myself
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)  // Set timer to prevent repeated casting
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_IMPROVED_HASTE)  // 2613 (WIZARD_IMPROVED_HASTE)
    Range(NearestEnemyOf(Myself),30)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,89)
        Spell(Myself,WIZARD_IMPROVED_HASTE)  // Cast WIZARD_IMPROVED_HASTE
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Blur if conditions are met
IF
    ActionListEmpty()
    HaveSpell(WIZARD_BLUR)  // Ensure the Blur spell is available
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")  // Ensure previous spell cast timer has expired
    !StateCheck(Myself,STATE_BLUR)  // Ensure Blur is not already active
THEN
    RESPONSE #100
        DisplayStringHead(Myself,90)
        Spell(Myself,WIZARD_BLUR)  // Cast Blur on Myself
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)  // Set timer to prevent repeated casting
END

// Cast Luck if conditions are met
IF
    ActionListEmpty()
    HaveSpell(WIZARD_LUCK)  // Ensure the Luck spell is available
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")  // Ensure previous spell cast timer has expired
THEN
    RESPONSE #100
        DisplayStringHead(Myself,91)
        Spell(Myself,WIZARD_LUCK)  // Cast Luck on Myself
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)  // Set timer to prevent repeated casting
END



// Cast Melf's Minute Meteors if conditions are met
IF
    ActionListEmpty()
    HaveSpell(WIZARD_MELF_METEOR)  // Ensure Melf's Minute Meteors spell is available
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")  // Ensure previous spell cast timer has expired
THEN
    RESPONSE #100
        DisplayStringHead(Myself,92)
        Spell(Myself,WIZARD_MELF_METEOR)  // Cast Melf's Minute Meteors on Myself
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)  // Set timer to prevent repeated casting
END

IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    StateCheck(Myself,STATE_SILENCED)
    HaveSpell(WIZARD_VOCALIZE)  // SPWI219.SPL (Vocalize)
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,93)
        Spell(Myself,WIZARD_VOCALIZE)  // Cast Vocalize if silenced
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    HaveSpell(WIZARD_PROTECTION_FROM_EVIL)  // Ensure the spell is available
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,94)
        Spell(Myself,WIZARD_PROTECTION_FROM_EVIL) // Cast Protection from Evil on Myself
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// COMBAT DEFENSIVE SPELLS (WIZARD)
// ======================================================

IF
    ActionListEmpty()
    HaveSpell(WIZARD_MINOR_SPELL_DEFLECTION)  // SPWI318.SPL (Minor Spell Deflection)
    !HasBounceEffects(Myself)
    !HasImmunityEffects(Myself)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerNotExpired("CASTER_ENEMY","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,95)
        Spell(Myself,WIZARD_MINOR_SPELL_DEFLECTION)  // Cast Minor Spell Deflection
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_MINOR_SPELL_TURNING)  // SPWI522.SPL (Minor Spell Turning)
    !HasBounceEffects(Myself)
    !HasImmunityEffects(Myself)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerNotExpired("CASTER_ENEMY","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,96)
        Spell(Myself,WIZARD_MINOR_SPELL_TURNING)  // Cast Minor Spell Turning
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_SPELL_TURNING)  // SPWI701.SPL (Spell Turning)
    !HasBounceEffects(Myself)
    !HasImmunityEffects(Myself)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerNotExpired("CASTER_ENEMY","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,97)
        Spell(Myself,WIZARD_SPELL_TURNING)  // Cast Spell Turning
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_INVISIBILITY)  // SPWI206.SPL (Invisibility)
    !StateCheck(Myself,STATE_INVISIBLE)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,98)
        Spell(Myself,WIZARD_INVISIBILITY)  // Cast Invisibility if not already invisible
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// COMBAT DEFENSIVE SPELLS (CLERIC)
// ======================================================


IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HaveSpell(CLERIC_ARMOR_OF_FAITH)  // SPPR111.SPL (Armor of Faith)
    !CheckSpellState(Myself,ARMOR_OF_FAITH)  // Correct spell state for Armor of Faith
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,99)
        Spell(Myself,CLERIC_ARMOR_OF_FAITH)  // Cast Armor of Faith
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_CHANT)  
    StateCheck(Myself,STATE_CHANT)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,100)
        Spell(Myself,CLERIC_CHANT)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    StateCheck(Myself,STATE_BLESS)
    HaveSpell(CLERIC_BLESS)  
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,101)
        Spell(Myself,CLERIC_BLESS)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_SANCTUARY)  // SPPR109.SPL (Sanctuary)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HPPercentLT(Myself,40)  // Party member's HP is below 25%
      // The target was last seen by the cleric
THEN
    RESPONSE #100
        DisplayStringHead(Myself,102)
        Spell(LastSeenBy(Myself),CLERIC_SANCTUARY)  // Cast Sanctuary on the party member with low HP
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_PROTECTION_FROM_EVIL_10_FOOT)  // SPPR107.SPL (Protection from Evil)
    !CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,103)
        Spell(Myself,CLERIC_PROTECTION_FROM_EVIL_10_FOOT)  // Cast Protection from Evil
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_PROTECTION_FROM_FIRE)  
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerExpired("FIRE_ENEMIES","LOCALS")
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,104)
        Spell(Myself,CLERIC_PROTECTION_FROM_FIRE)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_DEFENSIVE_HARMONY)  
    See([PC])
    !CheckStatLT(LastSeenBy(Myself),1,CLERIC_DEFENSIVE_HARMONY)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,105)
        Spell(LastSeenBy(Myself),CLERIC_DEFENSIVE_HARMONY)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_BARKSKIN)  
    See([PC])
    !CheckSpellState(LastSeenBy(Myself),BARKSKIN)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,106)
        Spell(LastSeenBy(Myself),CLERIC_BARKSKIN)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_PIXIE_DUST)  
    See([PC])
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,107)
        Spell(LastSeenBy(Myself),CLERIC_PIXIE_DUST)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_IRONSKIN)  
    See([PC])
    !CheckSpellState(LastSeenBy(Myself),IRON_SKINS)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,108)
        Spell(LastSeenBy(Myself),CLERIC_IRONSKIN)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_FLAME_BLADE)  
    GlobalTimerNotExpired("TROLL_ENEMIES","LOCALS")
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,109)
        Spell(Myself,CLERIC_FLAME_BLADE)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_SPIRITUAL_HAMMER)  
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,110)
        Spell(Myself,CLERIC_SPIRITUAL_HAMMER)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_SANCTUARY)  // SPPR109.SPL (Sanctuary)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HPPercentLT(Myself,50)  // Party member's HP is below 25%
THEN
    RESPONSE #100
        DisplayStringHead(Myself,111)
        Spell(Myself,CLERIC_SANCTUARY)  // Cast Sanctuary on the party member with low HP
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HaveSpell(CLERIC_PROTECT_FROM_EVIL)  // SPPR107.SPL (Protection from Evil)
    !CheckSpellState(Myself,PROTECTION_FROM_EVIL)  // Correct spell state for Protection from Evil
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,112)
        Spell(Myself,CLERIC_PROTECT_FROM_EVIL)  // Cast Protection from Evil
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HaveSpell(CLERIC_PROTECTION_FROM_EVIL_10_FOOT)  // SPPR107.SPL (Protection from Evil, 10' Radius)
    !CheckSpellState(Myself,PROTECTION_FROM_EVIL)  // Same state as Protection from Evil
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,113)
        Spell(Myself,CLERIC_PROTECTION_FROM_EVIL_10_FOOT)  // Cast Protection from Evil 10' Radius
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_HOLY_POWER)  
    !CheckSpellState(Myself,HOLY_POWER)  // State 9 for Holy Power
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,114)
        Spell(Myself,CLERIC_HOLY_POWER)  // Cast Holy Power for increased strength
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_RIGHTEOUS_MAGIC)  
    !CheckSpellState(Myself,ALLIED_RIGHTEOUS_WRATH_OF_THE_FAITHFUL)  // State 16 for Righteous Wrath of the Faithful (closest match)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,115)
        Spell(Myself,CLERIC_RIGHTEOUS_MAGIC)  // Cast Righteous Magic to increase combat abilities
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_DEATH_WARD)  
    !CheckSpellState(Myself,DEATH_WARD)  // State 8 for Death Ward
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,116)
        Spell(Myself,CLERIC_DEATH_WARD)  // Cast Death Ward to protect from death magic
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_CHAOTIC_COMMANDS)  
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !CheckSpellState(Myself,CHAOTIC_COMMANDS)  // State 41 for Chaotic Commands
    GlobalTimerNotExpired("PSYCHIC_ENEMIES","LOCALS")
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,117)
        Spell(Myself,CLERIC_CHAOTIC_COMMANDS)  // Cast Chaotic Commands to protect from mind control
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    HaveSpell(CLERIC_FREE_ACTION)  
    !CheckSpellState(Myself,FREE_ACTION)  // State 29 for Free Action
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,118)
        Spell(Myself,CLERIC_FREE_ACTION)  // Cast Free Action to avoid slow or hold effects
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END


// ======================================================
// IN COMBAT SPELLCASTING - Crowd Control (WIZARD)
// ======================================================


IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_SLEEP)  // SPWI101.SPL (Sleep)
    Range(NearestEnemyOf(Myself),30)
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    !Race(NearestEnemyOf(Myself),ELF)  // Exclude elves
    !General(NearestEnemyOf(Myself),UNDEAD)  // Exclude undead
    !See(NearestEnemyOfType([ENEMY.0.GOLEM]))
    !See(NearestEnemyOfType([ENEMY.0.MEPHIT]))
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,119)
        Spell(NearestEnemyOf(Myself),WIZARD_SLEEP)  // Cast Sleep
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_RAY_OF_ENFEEBLEMENT)  // SPWI103.SPL (Ray of Enfeeblement)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,120)
        Spell(NearestEnemyOf(Myself),WIZARD_RAY_OF_ENFEEBLEMENT)  // Cast Ray of Enfeeblement
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_SLOW)  // SPWI103.SPL (Ray of Enfeeblement)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,121)
        Spell(NearestEnemyOf(Myself),WIZARD_SLOW)  // Cast Ray of Enfeeblement
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_CONTAGION)  // SPWI104.SPL (Contagion)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,122)
        Spell(NearestEnemyOf(Myself),WIZARD_CONTAGION)  // Cast Contagion
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_HORROR)  // SPWI102.SPL (Horror)
    Range(NearestEnemyOf(Myself),30)
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    !Race(NearestEnemyOf(Myself),ELF)  // Exclude elves
    !General(NearestEnemyOf(Myself),UNDEAD)  // Exclude undead
    !Race(NearestEnemyOf(Myself),GOLEM)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,123)
        Spell(NearestEnemyOf(Myself),WIZARD_HORROR)  // Cast Horror
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END


IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_WEB)  // SPWI206.SPL (Web)
    !Race(NearestEnemyOf(Myself),SPIDER)  // Exclude spiders
    Range(NearestEnemyOf(Myself),30)
    Range(FarthestEnemyOf(NearestEnemyOf(Myself)),12)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,124)
        Spell(FarthestEnemyOf(Myself),WIZARD_WEB)  // Cast Web on any visible enemies
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    !Range(FarthestEnemyOf(NearestEnemyOf(Myself)),12)
    HaveSpell(WIZARD_GREASE)  // SPWI101.SPL (Grease)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,125)
        Spell(FarthestEnemyOf(Myself),WIZARD_GREASE)  // SPWI101.SPL (Grease)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    HaveSpell(WIZARD_HOLD_MONSTER)  // SPWI507.SPL (Hold Monster)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,126)
        Spell(NearestEnemyOf(Myself),WIZARD_HOLD_MONSTER)  // Cast Hold Monster
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_POWER_WORD_STUN)  // SPWI108.SPL (Power Word: Stun)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,127)
        Spell(NearestEnemyOf(Myself),WIZARD_POWER_WORD_STUN)  // Cast Power Word: Stun
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_SYMBOL_FEAR)  // SPWI109.SPL (Symbol of Fear)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,128)
        Spell(NearestEnemyOf(Myself),WIZARD_SYMBOL_FEAR)  // Cast Symbol of Fear
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_SYMBOL_STUN)  // SPWI110.SPL (Symbol of Stun)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,129)
        Spell(NearestEnemyOf(Myself),WIZARD_SYMBOL_STUN)  // Cast Symbol of Stun
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_SYMBOL_DEATH)  // SPWI111.SPL (Symbol of Death)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,130)
        Spell(NearestEnemyOf(Myself),WIZARD_SYMBOL_DEATH)  // Cast Symbol of Death
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_POWER_WORD_KILL)  // SPWI112.SPL (Power Word: Kill)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,131)
        Spell(NearestEnemyOf(Myself),WIZARD_POWER_WORD_KILL)  // Cast Power Word: Kill
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_ENERGY_DRAIN)  // SPWI113.SPL (Energy Drain)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,132)
        Spell(NearestEnemyOf(Myself),WIZARD_ENERGY_DRAIN)  // Cast Energy Drain
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),20)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_BLINDNESS)  // SPWI106.SPL (Blindness)
    !StateCheck(NearestEnemyOf(Myself),STATE_BLIND)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,133)
        Spell(NearestEnemyOf(Myself),WIZARD_BLINDNESS)  // SPWI106.SPL (Blindness)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    General(NearestEnemyOf(Myself),HUMANOID)
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    HaveSpell(WIZARD_CHARM_PERSON)  // SPWI104.SPL (Charm Person)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,134)
        Spell(NearestEnemyOf(Myself),WIZARD_CHARM_PERSON)  // SPWI104.SPL (Charm Person)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// IN COMBAT SPELLCASTING - Crowd Control (CLERIC)
// ======================================================

// Cast Hold Person
// Casts Hold Person to paralyze a humanoid target, rendering them immobile and unable to act.
// Lasts for 1 turn.
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    !General(NearestEnemyOf(Myself),HUMANOID)
    HaveSpell(CLERIC_HOLD_PERSON)  // SPPR012.SPL (Hold Person)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,135)
        Spell(NearestEnemyOf(Myself),CLERIC_HOLD_PERSON)  // Cast Hold Person to incapacitate the enemy
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_INSECT_PLAGUE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,136)
        Spell(NearestEnemyOf(Myself),CLERIC_INSECT_PLAGUE)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_SUMMON_INSECTS
IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_SUMMON_INSECTS)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,137)
        Spell(NearestEnemyOf(Myself),CLERIC_SUMMON_INSECTS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// IN COMBAT SPELLCASTING - OFFENSIVE Single Target (WIZARD)
// ======================================================


/* Magic Missile for enemies with more than 20 HP and no bounce effects */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_MAGIC_MISSILE)  // SPWI112.SPL (Magic Missile)
    HPGT(NearestEnemyOf(Myself),10)
    !HasBounceEffects(NearestEnemyOf(Myself))
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,138)
        Spell(NearestEnemyOf(Myself),WIZARD_MAGIC_MISSILE)  // SPWI112.SPL (Magic Missile)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Chromatic Orb for enemies with 10-20 HP, using level 1 spell */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_CHROMATIC_ORB)  // SPWI103.SPL (Chromatic Orb)
    HPGT(NearestEnemyOf(Myself),10)
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,139)
        Spell(NearestEnemyOf(Myself),WIZARD_CHROMATIC_ORB)  // SPWI103.SPL (Chromatic Orb)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Melf's Acid Arrow for enemies with 20-40 HP */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_MELF_ACID_ARROW)  // SPWI205.SPL (Melf's Acid Arrow)
    OR(2)
        HPGT(NearestEnemyOf(Myself),20)
        GlobalTimerNotExpired("TROLL_ENEMIES","LOCALS")
    !HasBounceEffects(NearestEnemyOf(Myself))
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,140)
        Spell(NearestEnemyOf(Myself),WIZARD_MELF_ACID_ARROW)  // SPWI205.SPL (Melf's Acid Arrow)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Flame Arrow for enemies with 40-60 HP */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_FLAME_ARROW)  // SPWI304.SPL (Flame Arrow)
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,141)
        Spell(NearestEnemyOf(Myself),WIZARD_FLAME_ARROW)  // SPWI304.SPL (Flame Arrow)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Power Word Kill for enemies with low HP */
IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(WIZARD_POWER_WORD_KILL)  // SPWI910.SPL (Power Word Kill)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,142)
        Spell(NearestEnemyOf(Myself), WIZARD_POWER_WORD_KILL)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Finger of Death for enemies with more than 100 HP */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_FINGER_OF_DEATH)  // SPWI704.SPL (Finger of Death)
    HPGT(NearestEnemyOf(Myself),100)
    !HasBounceEffects(NearestEnemyOf(Myself))
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,143)
        Spell(NearestEnemyOf(Myself),WIZARD_FINGER_OF_DEATH)  // SPWI704.SPL (Finger of Death)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Magic Missile as a fallback if all else fails */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_MAGIC_MISSILE)  // SPWI112.SPL (Magic Missile)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,144)
        Spell(NearestEnemyOf(Myself),WIZARD_MAGIC_MISSILE)  // SPWI112.SPL (Magic Missile)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// IN COMBAT SPELLCASTING - OFFENSIVE SINGLE TARGET (CLERIC)
// ======================================================


// Cast Flame Strike
// Casts Flame Strike to deal fire damage in a vertical column around the target.
// Lasts for 1 turn.
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(CLERIC_FLAME_STRIKE)  // SPPR009.SPL (Flame Strike)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,145)
        Spell(NearestEnemyOf(Myself),CLERIC_FLAME_STRIKE)  // Cast Flame Strike for vertical fire damage
END

// Cast Harm
// Casts Harm to deal a large amount of damage to the target, reducing their HP to 1.
// Lasts for 1 turn.
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HPPercentLT(NearestEnemyOf(Myself),75)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(CLERIC_HARM)  // SPPR010.SPL (Harm)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,146)
        Spell(NearestEnemyOf(Myself),CLERIC_HARM)  // Cast Harm to significantly reduce enemy's HP
END

// ======================================================
// Short Duration BUFFS (FIGHTER)
// ======================================================

IF
    ActionListEmpty()
    ActuallyInCombat()
    !CheckSpellState(Myself,HARDINESS)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,147)
        Spell(Myself,WARRIOR_HARDINESS)  // Activate Hardiness for extra protection
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) 
        Continue()
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,148)
        Spell(Myself, WARRIOR_GREATER_WHIRLWIND)  // Perform Greater Whirlwind Attack
        AttackOneRound(NearestEnemyOf(Myself))
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) 
        Continue()
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(MINSC_BERSERK)  // 3117 (MINSC_BERSERK)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,149)
        Spell(Myself,MINSC_BERSERK)  // Cast MINSC_BERSERK
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(BERSERKER_RAGE)  // 3117 (MINSC_BERSERK)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,150)
        Spell(Myself,BERSERKER_RAGE)  // Cast MINSC_BERSERK
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(BARBARIAN_RAGE)  // 3117 (MINSC_BERSERK)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,151)
        Spell(Myself,BARBARIAN_RAGE)  // Cast MINSC_BERSERK
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(KENSAI_KIA)  // 3117 (MINSC_BERSERK)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,152)
        Spell(Myself,KENSAI_KIA)  // Cast MINSC_BERSERK
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// PRE-COMBAT BUFFING (WIZARD)
// ======================================================

// Cast Spirit Armor
// Casts Spirit Armor to provide a magical shield that improves the wizard's armor class.
// Lasts for 1 hour per caster level.
IF
    ActionListEmpty()
    HaveSpell(WIZARD_SPIRIT_ARMOR)  // SPWI414.SPL (Spirit Armor)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    CheckStatGT(Myself,1,ARMORCLASS)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,153)
        Spell(Myself,WIZARD_SPIRIT_ARMOR)  // Cast Spirit Armor for increased defense
END

// Cast Stoneskin
// Casts Stoneskin to grant the wizard protection from physical damage by turning their skin to stone.
// Lasts for 1 turn per caster level.
IF
    ActionListEmpty()
    HaveSpell(WIZARD_STONE_SKIN)  // SPWI408.SPL (Stoneskin)
    CheckStatLT(Myself,1,STONESKINS)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,154)
        Spell(Myself,WIZARD_STONE_SKIN)  // Cast Stoneskin for increased damage resistance
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Ghost Armor
// Casts Ghost Armor to provide an ethereal shield that grants a bonus to armor class.
// Lasts for 1 round per caster level.
IF
    ActionListEmpty()
    HaveSpell(WIZARD_GHOST_ARMOR)  // SPWI317.SPL (Ghost Armor)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)  
    CheckStatLT(Myself,1,DEAD_MAGIC)   
    CheckStatGT(Myself,2,ARMORCLASS)   
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,155)
        Spell(Myself,WIZARD_GHOST_ARMOR)  // Cast Ghost Armor for improved defense
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Armor
// Casts Armor to provide a magical armor that improves the wizard's armor class.
// Lasts for 1 hour per caster level.
IF
    ActionListEmpty()
    HaveSpell(WIZARD_ARMOR)  // SPWI102.SPL (Armor)
    CheckStatGT(Myself,6,ARMORCLASS)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,156)
        Spell(Myself,WIZARD_ARMOR)  // Cast Armor for increased protection before combat
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Protection from Normal Missiles
// Casts Protection from Normal Missiles to grant immunity to normal missile attacks.
// Lasts for 1 hour
IF
    ActionListEmpty()
    HaveSpell(WIZARD_PROTECTION_FROM_NORMAL_MISSILES)  // SPWI107.SPL (Protection from Normal Missiles)
    CheckStatLT(Myself,1,WIZARD_PROTECTION_FROM_NORMAL_MISSILES)  // Check if Protection from Normal Missiles is already active
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,157)
        Spell(Myself,WIZARD_PROTECTION_FROM_NORMAL_MISSILES)  // Cast Protection from Normal Missiles
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END
// Cast Shield
// Casts Shield to provide a magical shield that improves the wizard's armor class and grants a +4 bonus to AC.
// Lasts for 1 turn per caster level.
IF
    ActionListEmpty()
    HaveSpell(WIZARD_SHIELD)  // SPWI114.SPL (Shield)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,158)
        Spell(Myself,WIZARD_SHIELD)  // Cast Shield for added protection
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Resist Fear
// Casts Resist Fear to grant the wizard immunity to fear effects.
// Lasts for 1 turn per caster level.
IF
    !ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(WIZARD_RESIST_FEAR)  // SPWI103.SPL (Resist Fear)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")  // Ensure the spell is not recently cast
THEN
    RESPONSE #100
        DisplayStringHead(Myself,159)
        Spell(Myself,WIZARD_RESIST_FEAR)  // Cast Resist Fear for protection against fear
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END
// Cast Protection from Petrification
// Casts Protection from Petrification to grant immunity to petrification attacks.
// Lasts for 1 hour
IF
    ActionListEmpty()
    !ActuallyInCombat()
    HaveSpell(WIZARD_PROTECTION_FROM_PETRIFICATION)  // SPWI212.SPL (Protection from Petrification)
    CheckStatLT(Myself,1,WIZARD_PROTECTION_FROM_PETRIFICATION)  // Check if Protection from Petrification is already active
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)
    GlobalTimerExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,160)
        Spell(Myself,WIZARD_PROTECTION_FROM_PETRIFICATION)  // Cast Protection from Petrification
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// SETTING TRAPS
// ======================================================

IF
    ActionListEmpty()
    Delay(30)
    HaveSpell(SET_SNARE_TRAP) 
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,161)
        Spell(Myself,SET_SNARE_TRAP) 
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    Delay(30)
    HaveSpell(SET_SPECIAL_SNARE_TRAP) 
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,162)
        Spell(Myself,SET_SPECIAL_SNARE_TRAP) 
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    Delay(30)
    HaveSpell(ROGUE_SET_SPIKE_TRAP) 
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,163)
        Spell(Myself,ROGUE_SET_SPIKE_TRAP) 
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    Delay(30)
    HaveSpell(ROGUE_SET_EXPLODING_TRAP)  
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,164)
        Spell(Myself,ROGUE_SET_EXPLODING_TRAP)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    Delay(30)
    HaveSpell(ROGUE_SET_EXPLODING_TRAP)  
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,165)
        Spell(Myself,ROGUE_SET_TIME_TRAP)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// STEALTH AND THIEVING
// ======================================================

IF
    ActionListEmpty()
    !ActuallyInCombat()
    !StateCheck(Myself,STATE_INVISIBLE)
    !StateCheck(Myself,STATE_IMPROVEDINVISIBILITY)
    OR(3)
        Class(Myself,THIEF_ALL)
        Class(Myself,RANGER_ALL)
        Class(Myself,MONK)
    !Range(NearestEnemyOf(Myself),15)
    Delay(24)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,166)
        Hide()  // Hide in Shadows if not in combat and no enemies nearby
        Continue()
END

IF
    ActionListEmpty()
    !ActuallyInCombat()
    OR(2)
        Class(Myself,THIEF_ALL)
        Class(Myself,MONK)
    Delay(24)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,167)
        FindTraps()  // Detect Traps if hidden and not in combat
        Wait(6)
        Continue()
END


IF
    Class(Myself,BARD_ALL)
    !ModalState(DETECTTRAPS)
    !StateCheck(Myself,STATE_SILENCED)
    !ModalState(BATTLESONG)
    Delay(24)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,168)
        BattleSong()
        Wait(6)
        Continue()
END

// ======================================================
//  TURN UNDEAD (CLERIC)
// ======================================================
IF
    See([EVILCUTOFF])
    General([EVILCUTOFF],UNDEAD)
    LevelGT(Myself,12)
    Delay(30)
    OR(2)
        Class(Myself,PALADIN_ALL)
        Class(Myself,CLERIC_ALL)
  THEN
    RESPONSE #100
        DisplayStringHead(Myself,169)
      Turn()
      Wait(6)
      Continue()
  END


// ======================================================
// COMBAT ACTIONS - RANGED ATTACKS
// ======================================================


// Use special bow ability
IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(ARCHER_CALL_SHOT) // Check if special ability is available
    See([ENEMY])
    !StateCheck(LastSeenBy(Myself),STATE_CHARMED)
    OR(3)
        WeaponEffectiveVs(LastSeenBy(Myself),MAINHAND)
        WeaponCanDamage(LastSeenBy(Myself),MAINHAND)
        !IsWeaponRanged(Myself)
    CanEquipRanged()
    !Range(LastSeenBy(Myself),4)
    CheckStatLT(LastSeenBy(Myself),100,RESISTMISSILE)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,170)
        EquipRanged()  // Equip ranged weapon
        Spell(Myself,ARCHER_CALL_SHOT) // Use special bow ability
        AttackOneRound(LastSeenBy(Myself))
        Continue()
END


IF
    ActionListEmpty()
    !ActuallyInCombat()
    See([ENEMY])
    !StateCheck(LastSeenBy(Myself),STATE_CHARMED)
    OR(3)
        WeaponEffectiveVs(LastSeenBy(Myself),MAINHAND)
        WeaponCanDamage(LastSeenBy(Myself),MAINHAND)
        !IsWeaponRanged(Myself)
    CanEquipRanged()
    !Range(LastSeenBy(Myself),4)  // If the enemy is within melee range (4 search squares)
    CheckStatLT(LastSeenBy(Myself),1,WIZARD_PROTECTION_FROM_NORMAL_MISSILES)  // Check if Protection from Normal Missiles is already active
THEN
    RESPONSE #100
        DisplayStringHead(Myself,171)
        EquipRanged()  // Equip ranged weapon
        AttackOneRound(LastSeenBy(Myself))
        Continue()
END


// ======================================================
// COMBAT ACTIONS - MELEE ATTACKS
// ======================================================

IF
    ActionListEmpty()
    ActuallyInCombat()
    WeaponEffectiveVs(LastSeenBy(Myself),MAINHAND)
    WeaponCanDamage(LastSeenBy(Myself),MAINHAND)
    !StateCheck(LastSeenBy(Myself),STATE_CHARMED)
    WeaponEffectiveVs(LastSeenBy(Myself),MAINHAND)
    WeaponCanDamage(LastSeenBy(Myself),MAINHAND)
    Range(NearestEnemyOf(Myself),4)  // If the enemy is within melee range (4 search squares)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,172)
        EquipMostDamagingMelee()  // Equip the most damaging melee weapon
        AttackOneRound(NearestEnemyOf(Myself))
        Continue()
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    !StateCheck(LastSeenBy(Myself),STATE_CHARMED)
    WeaponEffectiveVs(LastSeenBy(Myself),MAINHAND)
    WeaponCanDamage(LastSeenBy(Myself),MAINHAND)
    !GlobalTimerNotExpired("USE_RANGED","LOCALS")
    OR(2)
        Class(Myself,FIGHTER_ALL)
        Class(Myself,PALADIN_ALL)
    !Class(Myself,CLERIC_ALL)
    !Class(Myself,MAGE_ALL)
    !Class(Myself,DRUID_ALL)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,173)
        EquipMostDamagingMelee()  // Equip the most damaging melee weapon
        AttackOneRound(NearestEnemyOf(Myself))
        Continue()
END

// ======================================================
// RETREAT CONDITION
// ======================================================


IF
    See(NearestEnemyOf(Myself))
    Range(LastSeenBy(Myself),15)
    AttackedBy([ENEMY],DEFAULT)
    HPPercentLT(Myself,100)
    HaveSpell(WIZARD_SHADOW_DOOR)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,174)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
        FaceObject(LastSeenBy(Myself))
        Spell(Myself,WIZARD_SHADOW_DOOR)  // SPWI505.SPL (Shadow Door)
        RunAwayFrom(NearestEnemyOf(Myself),10)
END

IF
    See(NearestEnemyOf(Myself))
    Range(LastSeenBy(Myself),15)
    AttackedBy([ENEMY],DEFAULT)
    HPPercentLT(Myself,100)
    HaveSpell(WIZARD_MISLEAD)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,175)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
        FaceObject(LastSeenBy(Myself))
        Spell(Myself,WIZARD_MISLEAD)  // SPWI505.SPL (Shadow Door)
        RunAwayFrom(NearestEnemyOf(Myself),10)

END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HPPercentLT(Myself,37)
    !StateCheck(Myself,STATE_INVISIBLE)
    HaveSpell(WIZARD_INVISIBILITY)  // SPWI206.SPL (Invisibility)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,176)
        Spell(Myself,WIZARD_INVISIBILITY)  // Turn invisible to retreat
        RunAwayFrom(NearestEnemyOf(Myself),10)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    Delay(18)
    OR(4)
        Class(Myself,THIEF_ALL)
        Class(Myself,RANGER_ALL)
        Class(Myself,MONK)
        Class(Myself,MAGE_ALL)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,177)
        RunAwayFrom(NearestEnemyOf(Myself),8)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HPPercentLT(Myself,37)
    OR(3)
        Class(Myself,THIEF_ALL)
        Class(Myself,RANGER_ALL)
        Class(Myself,MONK)
    !StateCheck(Myself,STATE_INVISIBLE)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,178)
        RunAwayFrom(NearestEnemyOf(Myself),10)
        Hide()
=======
// ======================================================
// SECTION:GLOBALS
// ======================================================

// Set a timer for short-duration buffs
// This section sets a global timer to track the duration of short-duration buffs.
// The timer is set to two rounds initially and updated to one round when a hotkey is pressed.
IF
    ActuallyInCombat()
    GlobalTimerExpired("SHORT_BUFF","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,1)
        SetGlobalTimer("SHORT_BUFF","LOCALS",FIVE_ROUNDS)
        Continue()
END

IF
    CheckStatGT(Myself,0,WIZARD_IMPROVED_ALACRITY)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,2)
        SetGlobalTimer("WIZARD_CAST","LOCALS",0)
END

// This section sets a global timer for casting area-of-effect spells if there are more than 3 enemies nearby.
IF
    Delay(60)
    OR(4)
        Exists([EVILCUTOFF])
        AreaCheck("OH8200")
        AreaCheck("OH8300")
        AreaCheck("OH8400")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,3)
        SetGlobalTimer("SUMMON","LOCALS",ONE_TURN)
        Continue()
END

IF
    HotKey(K)  // Detect pressing of the 'B' key
THEN
    RESPONSE #100
        DisplayStringHead(Myself,4)
        SetGlobalTimer("SUMMON","LOCALS",ONE_TURN)  // Set the timer to one round
        Continue()
END

IF
    HotKey(B)  // Detect pressing of the 'B' key
THEN
    RESPONSE #100
        DisplayStringHead(Myself,5)
        SetGlobalTimer("SHORT_BUFF","LOCALS",ONE_TURN)  // Set the timer to one round
        Continue()
END


// ======================================================
// SECTION: Area Check
// ======================================================

//If I'm in the blackpits area, I cannot cast buffs/spells so just continue.
IF
    ActionListEmpty()
    AreaCheck("OH8100")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,6)
        Continue()
        Wait(10)
END

// ======================================================
// SECTION: ENEMY DETECTION
// ======================================================

/*
This section of the code is for determining which enemy is currently being faced. 
For each enemy type:
    set timer for enemy type

    Subsequent logic blocks will check these timers in conjuction or individually
    taking the resulting intelligent actions. 

    Example: facing fire elementals, do not use fire spells, 
    do cast fire protection spells if my resistance is low, 
    buff allies for fire protection if they are low. 
    Use specific items like charm fire elemental if the elemental is evil. 
*/


// See Fire Type Elemental with high resistance, don't use fire spells.
// General form [EA.GENERAL.RACE.CLASS.SPECIFIC.GENDER.ALIGN].
IF
    OR(2)
        Detect([ENEMY.0.0.ELEMENTAL_FIRE.0])
        Detect([ENEMY.0.0.GREY_OOZE])
    !GlobalTimerNotExpired("FIRE_ENEMIES","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,7)
        SetGlobalTimer("FIRE_ENEMIES","LOCALS",ONE_TURN)
        Continue()
END

IF
    ActuallyInCombat()
    OR(8)
        See(NearestEnemyOfType([ENEMY.0.0.MAGE_ALL]))
        See(NearestEnemyOfType([ENEMY.0.0.CLERIC_ALL]))
        See(NearestEnemyOfType([ENEMY.0.0.BARD_ALL]))
        See(NearestEnemyOfType([ENEMY.0.0.DRUID_ALL]))
        See(NearestEnemyOfType([ENEMY.0.0.SORCERER]))
        See(NearestEnemyOfType([ENEMY.0.0.RAKSHASA]))
        See(NearestEnemyOfType([ENEMY.0.LICH]))
        See(NearestEnemyOfType([ENEMY.0.DEMILICH]))
    GlobalTimerExpired("CASTER_ENEMY","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,8)
        SetGlobalTimer("CASTER_ENEMY","LOCALS",ONE_TURN)
        Continue()
END

// Detect Troll-type enemies, prepare to use anti-Troll strategies.
IF
    Detect([ENEMY.0.0.TROLL.0])
    !GlobalTimerNotExpired("TROLL_ENEMIES","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,9)
        SetGlobalTimer("TROLL_ENEMIES","LOCALS",ONE_TURN)
        Continue()
END

IF
    Detect([ENEMY.0.0.GREEN_SLIME])
    !GlobalTimerNotExpired("SLIME_ENEMIES","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,10)
        SetGlobalTimer("SLIME_ENEMIES","LOCALS",ONE_TURN)
        Continue()
END


IF
    OR(2)
        Detect([ENEMY.0.0.UMBERHULK.0])
        Detect([ENEMY.0.0.MIND_FLAYER.0])
        Detect([ENEMY.0.0.MIND_FLAYER.0])
        Detect([ENEMY.0.0.MIND_FLAYER.0])
    !GlobalTimerNotExpired("PSYCHIC_ENEMIES","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,11)
        SetGlobalTimer("PSYCHIC_ENEMIES","LOCALS",ONE_TURN)
        Continue()
END


// ======================================================
// SECTION: CHECK FOR CROWD CONTROLLED PARTY MEMBERS To USE RANGE
// ======================================================

// Check for crowd-controlled party members
// This section randomly walks if any party member is affected by crowd control spells or if the wizard is helpless.
IF
    ActionListEmpty()
    ActuallyInCombat()
    CheckStatLT(Myself,1,CLERIC_FREE_ACTION) // Check if party is being crowd-controlled
    CheckStatLT(Myself,1,MINORGLOBE)
    CheckStatLT(Myself,1,SHIELDGLOBE)
    CheckStatGT(Myself,2,SAVEVSSPELL) //and I got a reasonable chance of failing a save throw (25%+)
    OR(8)
        CheckStat([PC],1,WEB)
        CheckStat([PC],1,GREASE)
        StateCheck([PC],STATE_HELPLESS) // Check if the wizard is helpless
        SpellCast([ENEMY],WIZARD_WEB)  // SPWI215.SPL (Web)
        SpellCast([ENEMY.0.0.0],WIZARD_INCENDIARY_CLOUD)  // SPWI810.SPL (Incendiary Cloud)
        SpellCast([ENEMY.0.0.0],WIZARD_STINKING_CLOUD)  // SPWI213.SPL (Stinking Cloud)
        SpellCast([ENEMY.0.0.0],WIZARD_CLOUDKILL)  // SPWI502.SPL (Cloudkill)
        SpellCast([ENEMY.0.0.0],WIZARD_DEATH_FOG)  // SPWI614.SPL (Death Fog)
    See([ENEMY])
THEN
    RESPONSE #100
        DisplayStringHead(Myself,12)
        SetGlobalTimer("USE_RANGE","LOCALS",ONE_TURN)
        RunAwayFrom(LastSeenBy(Myself),16)
        Continue()
END


// Cast Zone of Sweet Air if affected by Stinking Cloud
// This section casts Zone of Sweet Air if the wizard or party members are affected by Stinking Cloud.
IF
    OR(4)
        SpellCast([ENEMY.0.0.0],WIZARD_INCENDIARY_CLOUD)  // SPWI810.SPL (Incendiary Cloud)
        SpellCast([ENEMY.0.0.0],WIZARD_STINKING_CLOUD)  // SPWI213.SPL (Stinking Cloud)
        SpellCast([ENEMY.0.0.0],WIZARD_CLOUDKILL)  // SPWI502.SPL (Cloudkill)
        SpellCast([ENEMY.0.0.0],WIZARD_DEATH_FOG)  // SPWI614.SPL (Death Fog)
    HaveSpell(CLERIC_ZONE_OF_SWEET_AIR)  // SPPR318.SPL (Zone of Sweet Air)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,13)
        Spell(Myself,CLERIC_ZONE_OF_SWEET_AIR)  // Cast Zone of Sweet Air to counteract Stinking Cloud
END


// ======================================================
// SECTION: Heal SPELLS (CLERIC)
// ======================================================


// Description: EXALTATION: This spell enables a priest to aid and protect any one being other than themselves. 
// By touch, the caster removes the effects of fear, sleep, feeblemind, unconsciousness, and intoxication, 
//as well as berserk and confused states of mind. In addition, the recipient is protected 
//against spells and other attacks that cause these effects for 1 turn.
IF
    ActionListEmpty()
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpellRES("OHTYR1") //Exaltation filename. 
    See([PC])
    OR(8)
        GlobalTimerNotExpired("CASTER_ENEMY","LOCALS")
        CheckStat(LastSeenBy(Myself),1,WEB)
        CheckStat(LastSeenBy(Myself),1,GREASE)
        StateCheck(LastSeenBy(Myself),STATE_HELPLESS)
        StateCheck(LastSeenBy(Myself),STATE_SLEEPING)
        StateCheck(LastSeenBy(Myself),STATE_FEEBLEMINDED)
        StateCheck(LastSeenBy(Myself),STATE_PANIC)
        StateCheck(LastSeenBy(Myself),STATE_CONFUSED)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,14)
        SpellRES("OHTYR1",LastSeenBy(Myself))
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    !ActuallyInCombat()
    See([PC])
    OR(1)
        StateCheck(LastSeenBy(Myself),STATE_BERSERK) 
THEN
    RESPONSE #100
        DisplayStringHead(Myself,15)
        SpellRES("OHTYR1",LastSeenBy(Myself))
END

IF
    ActionListEmpty()
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_FREE_ACTION) //Exaltation filename. 
    See([PC])
    OR(3)
        CheckStat(LastSeenBy(Myself),1,WEB)
        CheckStat(LastSeenBy(Myself),1,GREASE)
        CheckSpellState(LastSeenBy(Myself),ENTANGLE)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,16)
        Spell(LastSeenBy(Myself),CLERIC_FREE_ACTION)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// Heal Light Wounds
IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],70) // Heal when HP is below 70
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_CURE_LIGHT_WOUNDS)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,17)
        Spell(LastSeenBy(Myself),CLERIC_CURE_LIGHT_WOUNDS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// Heal Light Wounds
IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],70) // Heal when HP is below 70
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_AID)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,18)
        Spell(LastSeenBy(Myself),CLERIC_AID)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer (adjust as needed)
END

// Heal Light Wounds
IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],60) // Heal when HP is below 70
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_MASS_CURE)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,19)
        Spell(LastSeenBy(Myself),CLERIC_MASS_CURE)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer (adjust as needed)
END

IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],70) // Heal when HP is below 70
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_CURE_MEDIUM_WOUNDS)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,20)
        Spell(LastSeenBy(Myself),CLERIC_CURE_MEDIUM_WOUNDS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer (adjust as needed)
END

IF
    ActionListEmpty()
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    OR(2)
        StateCheck([GOODCUTOFF],STATE_STUNNED)
        CheckStatGT([GOODCUTOFF],0,HELD)
    See([GOODCUTOFF])
    HaveSpell(CLERIC_REMOVE_PARALYSIS)  // SPPR308.SPL (Remove Paralysis)
    !StateCheck(LastSeenBy(Myself),STATE_IMPROVEDINVISIBILITY)
    CheckStat(LastSeenBy(Myself),0,MINORGLOBE)
    !StateCheck(LastSeenBy(Myself),STATE_CONFUSED)
    !StateCheck(LastSeenBy(Myself),STATE_CHARMED)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,21)
        SetInterrupt(FALSE)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
        Spell(LastSeenBy(Myself),CLERIC_REMOVE_PARALYSIS)  // SPPR308.SPL (Remove Paralysis)
        SetInterrupt(TRUE)
END

IF
    ActionListEmpty()
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    OR(2)
        StateCheck([GOODCUTOFF],STATE_STUNNED)
        CheckStatGT([GOODCUTOFF],0,HELD)
    See([GOODCUTOFF])
    HaveSpell(CLERIC_REMOVE_PARALYSIS) 
    !StateCheck(LastSeenBy(Myself),STATE_IMPROVEDINVISIBILITY)
    CheckStat(LastSeenBy(Myself),0,MINORGLOBE)
    !StateCheck(LastSeenBy(Myself),STATE_CONFUSED)
    !StateCheck(LastSeenBy(Myself),STATE_CHARMED)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,22)
        SetInterrupt(FALSE)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
        Spell(LastSeenBy(Myself),CLERIC_REMOVE_PARALYSIS) 
        SetInterrupt(TRUE)
END

// Heal Serious Wounds
IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],50) // Heal when HP is below 70
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_CURE_SERIOUS_WOUNDS)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,23)
        Spell(Myself,CLERIC_CURE_SERIOUS_WOUNDS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_CHAOTIC_COMMANDS)  // SPPR303.SPL (Dispel Magic)
    Allegiance(Myself,GOODCUTOFF)
    See([PC])
    OR(2)
        StateCheck(LastSeenBy(Myself),STATE_CHARMED)
        StateCheck(LastSeenBy(Myself),STATE_CONFUSED)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,24)
        Spell(LastSeenBy(Myself),CLERIC_CHAOTIC_COMMANDS)  // SPPR303.SPL (Dispel Magic)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_DISPEL_MAGIC)  // SPPR303.SPL (Dispel Magic)
    Allegiance(Myself,GOODCUTOFF)
    See([PC])
    OR(4)
        StateCheck(LastSeenBy(Myself),STATE_CHARMED)
        StateCheck(LastSeenBy(Myself),STATE_CONFUSED)
        StateCheck(LastSeenBy(Myself),STATE_STUNNED)
        CheckStatGT(LastSeenBy(Myself),0,HELD)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,25)
        Spell(LastSeenBy(Myself),CLERIC_DISPEL_MAGIC)  // SPPR303.SPL (Dispel Magic)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END


IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    OR(3)
        StateCheck([GOODCUTOFF],STATE_STUNNED)
        CheckStatGT([GOODCUTOFF],0,HELD)
        CheckStatGT([PC],0,LEVELDRAIN)
    HaveSpell(CLERIC_RESTORATION)  // 1713 (CLERIC_RESTORATION)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,26)
        Spell(LastSeenBy(Myself),CLERIC_RESTORATION)  // Cast CLERIC_RESTORATION
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    See([PC])
    HaveSpell(CLERIC_LESSER_RESTORATION)  // 1713 (CLERIC_RESTORATION)
    OR(3)
        StateCheck([GOODCUTOFF],STATE_STUNNED)
        CheckStatGT([GOODCUTOFF],0,HELD)
        CheckStatGT([PC],0,LEVELDRAIN)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,27)
        Spell(LastSeenBy(Myself),CLERIC_LESSER_RESTORATION)  // Cast CLERIC_RESTORATION
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// Heal Critical Wounds
IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],50) // Heal when HP is below 20
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_CURE_CRITICAL_WOUNDS)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,28)
        Spell(LastSeenBy(Myself),CLERIC_CURE_CRITICAL_WOUNDS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END

IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],50) // Heal when HP is below 20
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HaveSpell(CLERIC_HEAL)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,29)
        Spell(LastSeenBy(Myself),CLERIC_HEAL)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END

IF
    ActionListEmpty()
    See([PC])
    HPPercentLT([PC],75)
    HaveSpell(PALADIN_LAY_ON_HANDS)  // 4211 (PALADIN_LAY_ON_HANDS)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,30)
        Spell(LastSeenBy(Myself),PALADIN_LAY_ON_HANDS)  // Cast PALADIN_LAY_ON_HANDS
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
//  SECTIONL: Heal (WIZARD)
// ======================================================

IF
    ActionListEmpty()
    HaveSpell(WIZARD_REMOVE_MAGIC)  // SPPR303.SPL (Dispel Magic)
    Allegiance(Myself,GOODCUTOFF)
    See([PC])
    OR(4)
        StateCheck(LastSeenBy(Myself),STATE_CHARMED)
        StateCheck(LastSeenBy(Myself),STATE_CONFUSED)
        StateCheck(LastSeenBy(Myself),STATE_STUNNED)
        CheckStatGT(LastSeenBy(Myself),0,HELD)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,31)
        Spell(LastSeenBy(Myself),WIZARD_REMOVE_MAGIC)  // SPPR303.SPL (Dispel Magic)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND) // Set a 2-minute timer
END

// ======================================================
// SECTION: Heal ITEMS 
// ======================================================


IF
    ActionListEmpty()
    HPPercentLT(Myself,50)
    PartyHasItem("POTN55")  // Potion of Superior Healing
THEN
    RESPONSE #100
        DisplayStringHead(Myself,32)
        TakePartyItem("POTN55")
        UseItem("POTN55",Myself)  // Potion of Superior Healing
END

IF
    ActionListEmpty()
    HPPercentLT(Myself,50)
    PartyHasItem("POTN52")  // Potion of Superior Healing
THEN
    RESPONSE #100
        DisplayStringHead(Myself,33)
        TakePartyItem("POTN52")
        UseItem("POTN52",Myself)  // Potion of Superior Healing
END

IF
    ActionListEmpty()
    HPPercentLT(Myself,50)
    PartyHasItem("POTN08")  // Potion of Superior Healing
THEN
    RESPONSE #100
        DisplayStringHead(Myself,34)
        TakePartyItem("POTN08")
        UseItem("POTN08",Myself)  // Potion of Superior Healing
END

IF
    ActionListEmpty()
    HPPercentLT(Myself,35)
    !StateCheck(Myself,STATE_INVISIBLE)
    PartyHasItem("POTN10")  // Potion of Invisibility
THEN
    RESPONSE #100
        DisplayStringHead(Myself,35)
        TakePartyItem("POTN10")
        UseItem("POTN10",Myself)  
END

IF
    ActionListEmpty()
    !CheckSpellState(Myself,POTION_OF_CLARITY)
    !ExtendedStateCheck(Myself,STATE_CHAOTIC_COMMANDS)
    CheckStatLT(Myself,1,CLERIC_CHAOTIC_COMMANDS)    
    GlobalTimerNotExpired("PSYCHIC_ENEMIES","LOCALS")
    PartyHasItem("POTN21")  // Potion of Clarity
THEN
    RESPONSE #100
        DisplayStringHead(Myself,36)
        DisplayStringHead(Myself,2796)
        //TakePartyItem("POTN21")
        UseItem("POTN21",Myself)  
END

IF
    ActionListEmpty()
    !CheckSpellState(Myself,FREE_ACTION)
    CheckStatLT(Myself,1,CLERIC_FREE_ACTION)    
    Delay(1000)
    GlobalTimerNotExpired("PSYCHIC_ENEMIES","LOCALS")
    PartyHasItem("POTN45")  // Potion of Freedom
THEN
    RESPONSE #100
        DisplayStringHead(Myself,37)
        DisplayStringHead(Myself,2796)
        //TakePartyItem("POTN45")
        UseItem("POTN45",Myself)  
END

//Poison Management
IF
    StateCheck(Myself,STATE_POISONED)
    HPPercentLT(Myself,76)
    PartyHasItem("POTN20") // Antidote
THEN
    RESPONSE #100
        DisplayStringHead(Myself,38)
        TakePartyItem("POTN20")
        UseItem("POTN20",Myself) // Antidote
END

IF
    ActionListEmpty()
    StateCheck(Myself,STATE_POISONED)
    HPPercentLT(Myself,76)
    PartyHasItem("POTN17") // Elixir of Health
THEN
    RESPONSE #100
        DisplayStringHead(Myself,39)
        TakePartyItem("POTN17")
        UseItem("POTN17",Myself) // Elixir of Health
END


// ======================================================
// SECTION: PENETRATION SPELLS (WIZARD)
// ======================================================

IF
    ActuallyInCombat()
    ActionListEmpty()
    OR(6)
    See([ENEMY.0.0.MAGE_ALL])
    See([ENEMY.0.0.CLERIC_ALL])
    See([ENEMY.0.0.BARD_ALL])
    See([ENEMY.0.0.DRUID_ALL])
    See([ENEMY.0.0.SORCERER])
    See([ENEMY.0.0.RAKSHASA])    
    HaveSpell(WIZARD_SPELL_STRIKE)  
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,40)
        Spell(LastSeenBy(Myself),WIZARD_SPELL_STRIKE)  
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See([ENEMY])
    !StateCheck(LastSeenBy(Myself),STATE_NOT_TARGETABLE)
    !ImmuneToSpellLevel(LastSeenBy(Myself),5)
    OR(5)
        CheckStatGT(LastSeenBy(Myself),0,STONESKINS)
        CheckSpellState(LastSeenBy(Myself),PROTECTION_FROM_MAGICAL_WEAPONS)
        CheckSpellState(LastSeenBy(Myself),MANTLE)
        CheckSpellState(LastSeenBy(Myself),IMPROVED_MANTLE)
        CheckSpellState(LastSeenBy(Myself),ABSOLUTE_IMMUNITY)
    !CheckStatGT(Myself,0,CLERIC_INSECT_PLAGUE)
    !StateCheck(Myself,STATE_SILENCED)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    HaveSpell(WIZARD_BREACH)
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,41)
        SetInterrupt(FALSE)
        Spell(LastSeenBy(Myself),WIZARD_BREACH)  
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
        SetInterrupt(TRUE)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See([ENEMY])
    !StateCheck(LastSeenBy(Myself),STATE_NOT_TARGETABLE)
    !ImmuneToSpellLevel(LastSeenBy(Myself),5)
    OR(5)
        CheckStatGT(LastSeenBy(Myself),0,STONESKINS)
        CheckSpellState(LastSeenBy(Myself),PROTECTION_FROM_MAGICAL_WEAPONS)
        CheckSpellState(LastSeenBy(Myself),MANTLE)
        CheckSpellState(LastSeenBy(Myself),IMPROVED_MANTLE)
        CheckSpellState(LastSeenBy(Myself),ABSOLUTE_IMMUNITY)
    !CheckStatGT(Myself,0,CLERIC_INSECT_PLAGUE)
    !StateCheck(Myself,STATE_SILENCED)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    HaveSpell(WIZARD_REMOVE_MAGIC)
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,42)
        SetInterrupt(FALSE)
        Spell(LastSeenBy(Myself),WIZARD_REMOVE_MAGIC)  
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
        SetInterrupt(TRUE)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See([ENEMY])
    !StateCheck(LastSeenBy(Myself),STATE_NOT_TARGETABLE)
    !ImmuneToSpellLevel(LastSeenBy(Myself),3)
    OR(5)
        CheckStatGT(LastSeenBy(Myself),0,STONESKINS)
        CheckSpellState(LastSeenBy(Myself),PROTECTION_FROM_MAGICAL_WEAPONS)
        CheckSpellState(LastSeenBy(Myself),MANTLE)
        CheckSpellState(LastSeenBy(Myself),IMPROVED_MANTLE)
        CheckSpellState(LastSeenBy(Myself),ABSOLUTE_IMMUNITY)
    !CheckStatGT(Myself,0,CLERIC_INSECT_PLAGUE)
    !StateCheck(Myself,STATE_SILENCED)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    HaveSpell(WIZARD_SPELL_THRUST)
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,43)
        SetInterrupt(FALSE)
        Spell(LastSeenBy(Myself),WIZARD_SPELL_THRUST)  
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
        SetInterrupt(TRUE)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See([ENEMY])
    !StateCheck(LastSeenBy(Myself),STATE_NOT_TARGETABLE)
    !ImmuneToSpellLevel(LastSeenBy(Myself),4)
    OR(5)
        CheckStatGT(LastSeenBy(Myself),0,STONESKINS)
        CheckSpellState(LastSeenBy(Myself),PROTECTION_FROM_MAGICAL_WEAPONS)
        CheckSpellState(LastSeenBy(Myself),MANTLE)
        CheckSpellState(LastSeenBy(Myself),IMPROVED_MANTLE)
        CheckSpellState(LastSeenBy(Myself),ABSOLUTE_IMMUNITY)
    !CheckStatGT(Myself,0,CLERIC_INSECT_PLAGUE)
    !StateCheck(Myself,STATE_SILENCED)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    HaveSpell(WIZARD_SECRET_WORD)
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,44)
        SetInterrupt(FALSE)
        Spell(LastSeenBy(Myself),WIZARD_SECRET_WORD)  
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
        SetInterrupt(TRUE)
END

IF
    ActuallyInCombat()
    ActionListEmpty()  
    See([ENEMY])
    HaveSpell(WIZARD_GLITTERDUST)  
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,45)
        Spell(LastSeenBy(Myself),WIZARD_GLITTERDUST)  
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    OR(6)
    See([ENEMY.0.0.MAGE_ALL])
    See([ENEMY.0.0.CLERIC_ALL])
    See([ENEMY.0.0.BARD_ALL])
    See([ENEMY.0.0.DRUID_ALL])
    See([ENEMY.0.0.SORCERER])
    See([ENEMY.0.0.RAKSHASA])    
    HaveSpell(WIZARD_PIERCE_MAGIC)  
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,46)
        Spell(LastSeenBy(Myself),WIZARD_PIERCE_MAGIC)  
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    OR(6)
    See([ENEMY.0.0.MAGE_ALL])
    See([ENEMY.0.0.CLERIC_ALL])
    See([ENEMY.0.0.BARD_ALL])
    See([ENEMY.0.0.DRUID_ALL])
    See([ENEMY.0.0.SORCERER])
    See([ENEMY.0.0.RAKSHASA])    
    HaveSpell(WIZARD_WARDING_WHIP)  
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,47)
        Spell(NearestEnemyOf(Myself),WIZARD_WARDING_WHIP)  // Cast WIZARD_WARDING_WHIP
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    OR(6)
    See([ENEMY.0.0.MAGE_ALL])
    See([ENEMY.0.0.CLERIC_ALL])
    See([ENEMY.0.0.BARD_ALL])
    See([ENEMY.0.0.DRUID_ALL])
    See([ENEMY.0.0.SORCERER])
    See([ENEMY.0.0.RAKSHASA])    
    HaveSpell(WIZARD_PIERCE_MAGIC)  // 2608 (WIZARD_PIERCE_MAGIC)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,48)
        Spell(LastSeenBy(Myself),WIZARD_PIERCE_MAGIC)  // Cast WIZARD_PIERCE_MAGIC
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END


// ======================================================
// SECTION PENETRATION SPELLS (CLERIC)
// ======================================================

IF
    OR(6)
        See([ENEMY.0.0.MAGE_ALL])
        See([ENEMY.0.0.CLERIC_ALL])
        See([ENEMY.0.0.BARD_ALL])
        See([ENEMY.0.0.DRUID_ALL])
        See([ENEMY.0.0.SORCERER])
        See([ENEMY.0.0.RAKSHASA])
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(CLERIC_DISPEL_MAGIC)  // 1303 (CLERIC_DISPEL_MAGIC)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,49)
        Spell(LastSeenBy(Myself),CLERIC_DISPEL_MAGIC)  // Cast CLERIC_DISPEL_MAGIC
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    OR(6)
        See([ENEMY.0.0.MAGE_ALL])
        See([ENEMY.0.0.CLERIC_ALL])
        See([ENEMY.0.0.BARD_ALL])
        See([ENEMY.0.0.DRUID_ALL])
        See([ENEMY.0.0.SORCERER])
        See([ENEMY.0.0.RAKSHASA])
    HaveSpell(INQUIS_DISPEL_MAGIC)  // 4231 (INQUIS_DISPEL_MAGIC)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,50)
        Spell(LastSeenBy(Myself),INQUIS_DISPEL_MAGIC)  // Cast INQUIS_DISPEL_MAGIC
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    OR(6)
        Gender(LastSeenBy(Myself),ILLUSIONARY)
        SpellCast([ENEMY],WIZARD_PROJECT_IMAGE)  // SPWI703.SPL (Project Image)
        SpellCast([ENEMY],WIZARD_SIMULACRUM)  // SPWI804.SPL (Simulacrum)
        SpellCast([ENEMY],WIZARD_MISLEAD)  // SPWI607.SPL (Mislead)
        StateCheck(LastSeenBy(Myself),STATE_BLUR)
        StateCheck(LastSeenBy(Myself),STATE_MIRRORIMAGE)
    !GlobalTimerNotExpired("TrueSight","LOCALS")
    HaveSpell(INQUIS_TRUE_SIGHT)  // 4232 (INQUIS_TRUE_SIGHT)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,51)
        Spell(Myself,INQUIS_TRUE_SIGHT)  // Cast INQUIS_TRUE_SIGHT
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
        SetGlobalTimer("TrueSight","LOCALS",ONE_ROUND)
END

// ======================================================
// SECTION: SUMMONING SPELLS (CLERIC)
// ======================================================

// CLERIC_ETHER_GATE
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_ETHER_GATE)
    CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,52)
        Spell(Myself,CLERIC_ETHER_GATE)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_SUMMON_DEVA
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_SUMMON_DEVA)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,53)
        Spell(Myself,CLERIC_SUMMON_DEVA)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(PALADIN_SUMMON_DEVA)  // 4923 (PALADIN_SUMMON_DEVA)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,54)
        Spell(NearestEnemyOf(Myself),PALADIN_SUMMON_DEVA)  // Cast PALADIN_SUMMON_DEVA
        SetGlobalTimer("UNKNOWN_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_SUMMON_FALLEN_DEVA
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_SUMMON_FALLEN_DEVA)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,55)
        Spell(Myself,CLERIC_SUMMON_FALLEN_DEVA)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_CONJURE_FIRE_ELEMENTAL
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_CONJURE_FIRE_ELEMENTAL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,56)
        Spell(Myself,CLERIC_CONJURE_FIRE_ELEMENTAL)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_CONJURE_EARTH_ELEMENTAL
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_CONJURE_EARTH_ELEMENTAL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,57)
        Spell(Myself,CLERIC_CONJURE_EARTH_ELEMENTAL)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_GATE
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    HaveSpell(CLERIC_GATE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,58)
        Spell(Myself,CLERIC_GATE)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END


// CLERIC_ANIMAL_SUMMONING_1
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_ANIMAL_SUMMONING_1)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,59)
        Spell(Myself,CLERIC_ANIMAL_SUMMONING_1)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_CALL_WOODLAND_BEINGS
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_CALL_WOODLAND_BEINGS)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,60)
        Spell(Myself,CLERIC_CALL_WOODLAND_BEINGS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_ANIMAL_SUMMONING_2
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_ANIMAL_SUMMONING_2)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,61)
        Spell(Myself,CLERIC_ANIMAL_SUMMONING_2)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_AERIAL_SERVANT
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_AERIAL_SERVANT)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,62)
        Spell(Myself,CLERIC_AERIAL_SERVANT)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_ANIMAL_SUMMONING_3
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_ANIMAL_SUMMONING_3)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,63)
        Spell(Myself,CLERIC_ANIMAL_SUMMONING_3)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_CONJURE_ANIMALS
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_CONJURE_ANIMALS)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,64)
        Spell(Myself,CLERIC_CONJURE_ANIMALS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_ELEMENTAL_SWARM
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_ELEMENTAL_SWARM)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,65)
        Spell(Myself,CLERIC_ELEMENTAL_SWARM)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_GREATER_ELEMENTAL_SWARM
IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(CLERIC_GREATER_ELEMENTAL_SWARM)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,66)
        Spell(Myself,CLERIC_GREATER_ELEMENTAL_SWARM)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// SECTION: SUMMONING SPELLS (WIZARD)
// ======================================================

IF
    ActionListEmpty()
    HaveSpell(WIZARD_SUMMON_PLANATAR_EVIL)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SUMMON","LOCALS")
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,67)
        Spell(Myself,WIZARD_SUMMON_PLANATAR_EVIL)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_SUMMON_PLANATAR_GOOD)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,68)
        Spell(Myself,WIZARD_SUMMON_PLANATAR_GOOD)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_GATE)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,69)
        Spell(Myself,WIZARD_GATE)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_SUMMON_FIEND)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SUMMON","LOCALS")
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,70)
        Spell(Myself,WIZARD_SUMMON_FIEND)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell( WIZARD_SIMULACRUM)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SUMMON","LOCALS")
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,71)
        Spell(Myself, WIZARD_SIMULACRUM)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END


IF
    ActionListEmpty()
    HaveSpell(WIZARD_SUMMON_DJINNI)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SUMMON","LOCALS")
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,72)
        Spell(Myself,WIZARD_SUMMON_DJINNI)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_SUMMON_HAKEASHAR)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,73)
        Spell(Myself,WIZARD_SUMMON_HAKEASHAR)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_SUMMON_EFREET)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,74)
        Spell(Myself,WIZARD_SUMMON_EFREET)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_MORDENKAINENS_SWORD)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,75)
        Spell(Myself,WIZARD_MORDENKAINENS_SWORD)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_CACOFIEND)  // SPWI615.SPL (Summon Hakeashar)
    CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,76)
        Spell(Myself,WIZARD_CACOFIEND)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END


IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_CARRION)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,77)
        Spell(Myself,WIZARD_CARRION)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_WYVERN_CALL)  // SPWI615.SPL (Summon Hakeashar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,78)
        Spell(Myself,WIZARD_WYVERN_CALL)  // Summon Hakeashar to disrupt enemy spellcasting
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_SUMMON_NISHRUU)  // SPWI514.SPL (Summon Nishruu)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,79)
        Spell(Myself,WIZARD_SUMMON_NISHRUU)  // Summon Nishruu to absorb enemy magic
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_INVISIBLE_STALKER)  // SPWI514.SPL (Summon Nishruu)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,80)
        Spell(Myself,WIZARD_INVISIBLE_STALKER)  // Summon Nishruu to absorb enemy magic
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END


IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_ANIMATE_DEAD)  // SPWI501.SPL (Animate Dead)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,81)
        Spell(Myself,WIZARD_ANIMATE_DEAD)  // Create undead allies
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_MONSTER_SUMMONING_3)  // SPWI611.SPL (Monster Summoning III)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,82)
        Spell(Myself,WIZARD_MONSTER_SUMMONING_3)  // Summon powerful monsters to assist in combat
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_SPIDER_SPAWN)  // SPWI423.SPL (Spider Spawn)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,83)
        Spell(Myself,WIZARD_SPIDER_SPAWN)  // Summon spiders to aid in combat
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_MONSTER_SUMMONING_2)  // SPWI511.SPL (Monster Summoning II)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,84)
        Spell(Myself,WIZARD_MONSTER_SUMMONING_2)  // Summon stronger monsters to assist in combat
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_MONSTER_SUMMONING_1)  // SPWI103.SPL (Summon Monster I)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,85)
        Spell(Myself,WIZARD_MONSTER_SUMMONING_1)  // Summon a monster to assist in combat
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SUMMON","LOCALS")
    HaveSpell(WIZARD_FIND_FAMILAR)  // SPWI123.SPL (Find Familiar)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    !CheckSpellState(Myself,DEAD_MAGIC_AREA)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,86)
        Spell(Myself,WIZARD_FIND_FAMILAR)  // Summon a familiar to assist
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END



// ======================================================
// SECTION: Short Duration BUFFS (WIZARD)
// ======================================================

IF
    ActionListEmpty()
    HaveSpell(WIZARD_MINOR_SPELL_DEFLECTION)  // SPWI318.SPL (Minor Spell Deflection)
    !HasBounceEffects(Myself)
    !HasImmunityEffects(Myself)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerNotExpired("CASTER_ENEMY","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,87)
        Spell(Myself,WIZARD_MINOR_SPELL_DEFLECTION)  // Cast Minor Spell Deflection
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_MINOR_SPELL_TURNING)  // SPWI522.SPL (Minor Spell Turning)
    !HasBounceEffects(Myself)
    !HasImmunityEffects(Myself)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerNotExpired("CASTER_ENEMY","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,88)
        Spell(Myself,WIZARD_MINOR_SPELL_TURNING)  // Cast Minor Spell Turning
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_SPELL_TURNING)  // SPWI701.SPL (Spell Turning)
    !HasBounceEffects(Myself)
    !HasImmunityEffects(Myself)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerNotExpired("CASTER_ENEMY","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,89)
        Spell(Myself,WIZARD_SPELL_TURNING)  // Cast Spell Turning
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_INVISIBILITY)  // SPWI206.SPL (Invisibility)
    !StateCheck(Myself,STATE_INVISIBLE)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,90)
        Spell(Myself,WIZARD_INVISIBILITY)  // Cast Invisibility if not already invisible
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_IMPROVED_INVISIBILITY)  // SPWI206.SPL (Invisibility)
    !StateCheck(Myself,STATE_IMPROVEDINVISIBILITY)
    !StateCheck(Myself,STATE_INVISIBLE)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,91)
        Spell(Myself,WIZARD_IMPROVED_INVISIBILITY)  // Cast Invisibility if not already invisible
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_MASS_INVISIBILITY)  // 2721 (WIZARD_MASS_INVISIBILITY)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,92)
        Spell(Myself,WIZARD_MASS_INVISIBILITY)  // Cast WIZARD_MASS_INVISIBILITY
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_MIRROR_IMAGE)  // 2721 (WIZARD_MASS_INVISIBILITY)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,93)
            Spell(Myself,WIZARD_MIRROR_IMAGE)  // Cast WIZARD_MASS_INVISIBILITY
            SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_LIMITED_WISH) 
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,94)
        Spell(Myself,WIZARD_LIMITED_WISH)  // Cast WIZARD_LIMITED_WISH
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    Class(Myself,MAGE_ALL)
    HaveSpell(WIZARD_IMPROVED_ALACRITY)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,95)
        Spell(Myself, WIZARD_IMPROVED_ALACRITY)  // Cast Improved Alacrity
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    HaveSpell(WIZARD_ENERGY_BLADES)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,96)
        Spell(Myself, WIZARD_ENERGY_BLADES)  // Cast Energy Blades
        Continue()
END

//This disables spell casting
IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(WIZARD_SHAPECHANGE)  // 2916 (WIZARD_SHAPECHANGE)
    HaveSpell(WIZARD_TENSERS_TRANSFORMATION)  // 2603 (WIZARD_TENSERS_TRANSFORMATION)
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,97)
            Spell(Myself,WIZARD_SHAPECHANGE)  // Cast WIZARD_SHAPECHANGE
            Spell(Myself,WIZARD_TENSERS_TRANSFORMATION)  // Cast WIZARD_TENSERS_TRANSFORMATION
            SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    HaveSpell(WIZARD_MINOR_GLOBE_OF_INVULNERABILITY)  // SPWI604.SPL (Globe of Invulnerability)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,98)
        Spell(Myself,WIZARD_MINOR_GLOBE_OF_INVULNERABILITY)  // Cast Globe of Invulnerability for spell protection
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_FIRE_SHIELD_BLUE)  
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,99)
            Spell(Myself,WIZARD_FIRE_SHIELD_BLUE)  
            SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_FIRE_SHIELD_RED)  
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,100)
            Spell(Myself,WIZARD_FIRE_SHIELD_RED)  
            SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_PROTECTION_FROM_FIRE)  
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,101)
            Spell(Myself,WIZARD_PROTECTION_FROM_FIRE)  
            SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_GLOBE_OF_INVULNERABILITY)  // 2602 (WIZARD_GLOBE_OF_INVULNERABILITY)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,102)
        Spell(Myself,WIZARD_GLOBE_OF_INVULNERABILITY)  // Cast WIZARD_GLOBE_OF_INVULNERABILITY
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END


// Cast Haste if conditions are met
IF
    ActionListEmpty()
    HaveSpell(WIZARD_HASTE)  // Ensure the Haste spell is available
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")  // Ensure previous spell cast timer has expired
    !StateCheck(Myself,STATE_HASTED)  // Ensure Haste is not already active
THEN
    RESPONSE #100
        DisplayStringHead(Myself,103)
        Spell(Myself,WIZARD_HASTE)  // Cast Haste on Myself
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)  // Set timer to prevent repeated casting
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_IMPROVED_HASTE)  // 2613 (WIZARD_IMPROVED_HASTE)
    Range(NearestEnemyOf(Myself),30)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,104)
        Spell(Myself,WIZARD_IMPROVED_HASTE)  // Cast WIZARD_IMPROVED_HASTE
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Blur if conditions are met
IF
    ActionListEmpty()
    HaveSpell(WIZARD_BLUR)  // Ensure the Blur spell is available
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")  // Ensure previous spell cast timer has expired
    !StateCheck(Myself,STATE_BLUR)  // Ensure Blur is not already active
THEN
    RESPONSE #100
        DisplayStringHead(Myself,105)
        Spell(Myself,WIZARD_BLUR)  // Cast Blur on Myself
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)  // Set timer to prevent repeated casting
END

// Cast Blur if conditions are met
IF
    ActionListEmpty()
    HaveSpell(WIZARD_CHAOS_SHIELD)  // Ensure the Blur spell is available
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")  // Ensure previous spell cast timer has expired
    !StateCheck(Myself,STATE_BLUR)  // Ensure Blur is not already active
THEN
    RESPONSE #100
        DisplayStringHead(Myself,106)
        Spell(Myself,WIZARD_CHAOS_SHIELD)  // Cast Blur on Myself
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)  // Set timer to prevent repeated casting
END

// Cast Luck if conditions are met
IF
    ActionListEmpty()
    HaveSpell(WIZARD_LUCK)  // Ensure the Luck spell is available
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")  // Ensure previous spell cast timer has expired
THEN
    RESPONSE #100
        DisplayStringHead(Myself,107)
        Spell(Myself,WIZARD_LUCK)  // Cast Luck on Myself
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)  // Set timer to prevent repeated casting
END



// Cast Melf's Minute Meteors if conditions are met
IF
    ActionListEmpty()
    HaveSpell(WIZARD_MELF_METEOR)  // Ensure Melf's Minute Meteors spell is available
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")  // Ensure previous spell cast timer has expired
THEN
    RESPONSE #100
        DisplayStringHead(Myself,108)
        Spell(Myself,WIZARD_MELF_METEOR)  // Cast Melf's Minute Meteors on Myself
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)  // Set timer to prevent repeated casting
END

IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    StateCheck(Myself,STATE_SILENCED)
    HaveSpell(WIZARD_VOCALIZE)  // SPWI219.SPL (Vocalize)
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,109)
        Spell(Myself,WIZARD_VOCALIZE)  // Cast Vocalize if silenced
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    GlobalTimerNotExpired("SHORT_BUFF","LOCALS")  // Timer expired
    HaveSpell(WIZARD_PROTECTION_FROM_EVIL)  // Ensure the spell is available
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,110)
        Spell(Myself,WIZARD_PROTECTION_FROM_EVIL) // Cast Protection from Evil on Myself
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END


// ======================================================
// SECTION: Short Duration BUFFS (CLERIC)
// ======================================================


IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HaveSpell(CLERIC_ARMOR_OF_FAITH)  // SPPR111.SPL (Armor of Faith)
    !CheckSpellState(Myself,ARMOR_OF_FAITH)  // Correct spell state for Armor of Faith
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,111)
        Spell(Myself,CLERIC_ARMOR_OF_FAITH)  // Cast Armor of Faith
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_DEFENSIVE_HARMONY)  
    See([PC])
    !CheckStatLT(LastSeenBy(Myself),1,CLERIC_DEFENSIVE_HARMONY)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,112)
        Spell(LastSeenBy(Myself),CLERIC_DEFENSIVE_HARMONY)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_CHANT)  
    StateCheck(Myself,STATE_CHANT)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,113)
        Spell(Myself,CLERIC_CHANT)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    StateCheck(Myself,STATE_BLESS)
    HaveSpell(CLERIC_BLESS)  
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,114)
        Spell(Myself,CLERIC_BLESS)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_SANCTUARY)  // SPPR109.SPL (Sanctuary)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HPPercentLT(Myself,60)  // Party member's HP is below 25%
      // The target was last seen by the cleric
THEN
    RESPONSE #100
        DisplayStringHead(Myself,115)
        Spell(LastSeenBy(Myself),CLERIC_SANCTUARY)  // Cast Sanctuary on the party member with low HP
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_PROTECTION_FROM_EVIL_10_FOOT)  // SPPR107.SPL (Protection from Evil)
    !CheckSpellState(Myself,PROTECTION_FROM_EVIL)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,116)
        Spell(Myself,CLERIC_PROTECTION_FROM_EVIL_10_FOOT)  // Cast Protection from Evil
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_PROTECTION_FROM_FIRE)  
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,117)
        Spell(Myself,CLERIC_PROTECTION_FROM_FIRE)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    See([PC])
    !CheckStatLT(LastSeenBy(Myself),100,RESISTFIRE)
    HaveSpell(CLERIC_PROTECTION_FROM_FIRE)  
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,118)
        Spell(LastSeenBy(Myself),CLERIC_PROTECTION_FROM_FIRE)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_BARKSKIN)  
    See([PC])
    !CheckSpellState(LastSeenBy(Myself),BARKSKIN)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,119)
        Spell(LastSeenBy(Myself),CLERIC_BARKSKIN)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_PIXIE_DUST)  
    See([PC])
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,120)
        Spell(LastSeenBy(Myself),CLERIC_PIXIE_DUST)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_IRONSKIN)  
    See([PC])
    !CheckSpellState(LastSeenBy(Myself),IRON_SKINS)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,121)
        Spell(LastSeenBy(Myself),CLERIC_IRONSKIN)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_FLAME_BLADE)  
    CheckStatGT(Myself,3,THAC0)
    GlobalTimerNotExpired("TROLL_ENEMIES","LOCALS")
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,122)
        Spell(Myself,CLERIC_FLAME_BLADE)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_SPIRITUAL_HAMMER)  
    CheckStatGT(Myself,3,THAC0)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,123)
        Spell(Myself,CLERIC_SPIRITUAL_HAMMER)  // Cast Protection from Fire on yourself
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_SANCTUARY)  // SPPR109.SPL (Sanctuary)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    HPPercentLT(Myself,50)  // Party member's HP is below 25%
THEN
    RESPONSE #100
        DisplayStringHead(Myself,124)
        Spell(Myself,CLERIC_SANCTUARY)  // Cast Sanctuary on the party member with low HP
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HaveSpell(CLERIC_PROTECTION_FROM_EVIL_10_FOOT)  // SPPR107.SPL (Protection from Evil, 10' Radius)
    !CheckSpellState(Myself,PROTECTION_FROM_EVIL)  // Same state as Protection from Evil
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,125)
        Spell(Myself,CLERIC_PROTECTION_FROM_EVIL_10_FOOT)  // Cast Protection from Evil 10' Radius
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HaveSpell(CLERIC_PROTECT_FROM_EVIL)  // SPPR107.SPL (Protection from Evil)
    !CheckSpellState(Myself,PROTECTION_FROM_EVIL)  // Correct spell state for Protection from Evil
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,126)
        Spell(Myself,CLERIC_PROTECT_FROM_EVIL)  // Cast Protection from Evil
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

//CHAOS OF BATTLE: Chaos of Battle applies bonuses to all allies and penalties to all enemies within a 30-ft. radius of the caster. The spell lasts 1 turn and will randomly affect the targets' Armor Class, Hit Points, THAC0, saves, or luck. The magnitude of the effect starts at 1 (5 for Hit Points) at level 1 and will improve by 1 (5 for Hit Points) every 6 levels of the caster.
IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpellRES("OHTMPS2")  
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    Delay(30)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,127)
        SpellRES("OHTMPS2",Myself) 
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

//BOON OF LATHANDER: This spell lasts 1 round per level of the caster. It gives the caster a +1 bonus to attack and damage rolls, a +1 bonus to all Saving Throws, and 1 extra attack per round. It also protects the recipient from level drain.
IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(LATHANDER_BOON)  
    !CheckSpellState(Myself,LATHANDER_BOON) 
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,128)
        Spell(Myself,LATHANDER_BOON)  
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_HOLY_POWER)  
    !CheckSpellState(Myself,HOLY_POWER)  // State 9 for Holy Power
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,129)
        Spell(Myself,CLERIC_HOLY_POWER)  // Cast Holy Power for increased strength
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_RIGHTEOUS_MAGIC)  
    !CheckSpellState(Myself,ALLIED_RIGHTEOUS_WRATH_OF_THE_FAITHFUL)  // State 16 for Righteous Wrath of the Faithful (closest match)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,130)
        Spell(Myself,CLERIC_RIGHTEOUS_MAGIC)  // Cast Righteous Magic to increase combat abilities
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_DEATH_WARD)  
    !CheckSpellState(Myself,DEATH_WARD)  // State 8 for Death Ward
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,131)
        Spell(Myself,CLERIC_DEATH_WARD)  // Cast Death Ward to protect from death magic
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(CLERIC_CHAOTIC_COMMANDS)  
    OR(2)
        !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
        GlobalTimerNotExpired("PSYCHIC_ENEMIES","LOCALS")
    !CheckSpellState(Myself,CHAOTIC_COMMANDS)  // State 41 for Chaotic Commands
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,132)
        Spell(Myself,CLERIC_CHAOTIC_COMMANDS)  // Cast Chaotic Commands to protect from mind control
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    See([PC])
    HaveSpell(CLERIC_CHAOTIC_COMMANDS)  
    OR(2)
        !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
        GlobalTimerNotExpired("PSYCHIC_ENEMIES","LOCALS")
    !CheckSpellState(LastSeenBy(Myself),CHAOTIC_COMMANDS)  // State 41 for Chaotic Commands
    CheckStatLT(LastSeenBy(Myself),1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,133)
        Spell(LastSeenBy(Myself),CLERIC_CHAOTIC_COMMANDS)  // Cast Chaotic Commands to protect from mind control
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  // Timer expired
    HaveSpell(CLERIC_FREE_ACTION)  
    !CheckSpellState(Myself,FREE_ACTION)  // State 29 for Free Action
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,134)
        Spell(Myself,CLERIC_FREE_ACTION)  // Cast Free Action to avoid slow or hold effects
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    See([PC])
    HaveSpell(CLERIC_FREE_ACTION)  
    !GlobalTimerExpired("SHORT_BUFF","LOCALS")  
    !CheckSpellState(LastSeenBy(Myself),FREE_ACTION)  
    GlobalTimerNotExpired("PSYCHIC_ENEMIES","LOCALS")
    CheckStatLT(LastSeenBy(Myself),1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,135)
        Spell(LastSeenBy(Myself),CLERIC_FREE_ACTION)  
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// IN COMBAT SPELLCASTING - Crowd Control (WIZARD)
// ======================================================

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_SLEEP)  // SPWI101.SPL (Sleep)
    Range(NearestEnemyOf(Myself),30)
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    !Race(NearestEnemyOf(Myself),ELF)  // Exclude elves
    !General(NearestEnemyOf(Myself),UNDEAD)  // Exclude undead
    !See(NearestEnemyOfType([ENEMY.0.GOLEM]))
    !See(NearestEnemyOfType([ENEMY.0.MEPHIT]))
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,136)
        Spell(NearestEnemyOf(Myself),WIZARD_SLEEP)  // Cast Sleep
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_RAY_OF_ENFEEBLEMENT)  // SPWI103.SPL (Ray of Enfeeblement)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,137)
        Spell(NearestEnemyOf(Myself),WIZARD_RAY_OF_ENFEEBLEMENT)  // Cast Ray of Enfeeblement
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_SLOW)  // SPWI103.SPL (Ray of Enfeeblement)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,138)
        Spell(NearestEnemyOf(Myself),WIZARD_SLOW)  // Cast Ray of Enfeeblement
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_CONTAGION)  // SPWI104.SPL (Contagion)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,139)
        Spell(NearestEnemyOf(Myself),WIZARD_CONTAGION)  // Cast Contagion
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_HORROR)  // SPWI102.SPL (Horror)
    Range(NearestEnemyOf(Myself),30)
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    !Race(NearestEnemyOf(Myself),ELF)  // Exclude elves
    !General(NearestEnemyOf(Myself),UNDEAD)  // Exclude undead
    !Race(NearestEnemyOf(Myself),GOLEM)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,140)
        Spell(NearestEnemyOf(Myself),WIZARD_HORROR)  // Cast Horror
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END


IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(WIZARD_WEB)  // SPWI206.SPL (Web)
    !Race(FarthestEnemyOf(Myself),SPIDER)  // Exclude spiders
    !Range(FarthestEnemyOf(Myself),8)
    Range(FarthestEnemyOf(NearestEnemyOf(Myself)),12)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,141)
        Spell(FarthestEnemyOf(Myself),WIZARD_WEB)  // Cast Web on any visible enemies
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    !Range(FarthestEnemyOf(NearestEnemyOf(Myself)),12)
    HaveSpell(WIZARD_GREASE)  // SPWI101.SPL (Grease)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,142)
        Spell(FarthestEnemyOf(Myself),WIZARD_GREASE)  // SPWI101.SPL (Grease)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    HaveSpell(WIZARD_HOLD_MONSTER)  // SPWI507.SPL (Hold Monster)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,143)
        Spell(NearestEnemyOf(Myself),WIZARD_HOLD_MONSTER)  // Cast Hold Monster
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_POWER_WORD_STUN)  // SPWI108.SPL (Power Word: Stun)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,144)
        Spell(NearestEnemyOf(Myself),WIZARD_POWER_WORD_STUN)  // Cast Power Word: Stun
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_SYMBOL_FEAR)  // SPWI109.SPL (Symbol of Fear)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,145)
        Spell(NearestEnemyOf(Myself),WIZARD_SYMBOL_FEAR)  // Cast Symbol of Fear
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_SYMBOL_STUN)  // SPWI110.SPL (Symbol of Stun)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,146)
        Spell(NearestEnemyOf(Myself),WIZARD_SYMBOL_STUN)  // Cast Symbol of Stun
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_SYMBOL_DEATH)  // SPWI111.SPL (Symbol of Death)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,147)
        Spell(NearestEnemyOf(Myself),WIZARD_SYMBOL_DEATH)  // Cast Symbol of Death
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_POWER_WORD_KILL)  // SPWI112.SPL (Power Word: Kill)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,148)
        Spell(NearestEnemyOf(Myself),WIZARD_POWER_WORD_KILL)  // Cast Power Word: Kill
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_ENERGY_DRAIN)  // SPWI113.SPL (Energy Drain)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,149)
        Spell(NearestEnemyOf(Myself),WIZARD_ENERGY_DRAIN)  // Cast Energy Drain
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),20)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_BLINDNESS)  // SPWI106.SPL (Blindness)
    !StateCheck(NearestEnemyOf(Myself),STATE_BLIND)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,150)
        Spell(NearestEnemyOf(Myself),WIZARD_BLINDNESS)  // SPWI106.SPL (Blindness)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),20)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_POLYMORPH_OTHER)  // SPWI106.SPL (Blindness)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,151)
        Spell(NearestEnemyOf(Myself),WIZARD_POLYMORPH_OTHER)  // SPWI106.SPL (Blindness)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),20)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_GREATER_MALISON)  // SPWI106.SPL (Blindness)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,152)
        Spell(NearestEnemyOf(Myself),WIZARD_GREATER_MALISON)  // SPWI106.SPL (Blindness)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),20)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_LOWER_RESISTANCE)  // SPWI106.SPL (Blindness)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,153)
        Spell(NearestEnemyOf(Myself),WIZARD_LOWER_RESISTANCE)  // SPWI106.SPL (Blindness)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    General(NearestEnemyOf(Myself),HUMANOID)
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    HaveSpell(WIZARD_CHARM_PERSON)  // SPWI104.SPL (Charm Person)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,154)
        Spell(NearestEnemyOf(Myself),WIZARD_CHARM_PERSON)  // SPWI104.SPL (Charm Person)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// IN COMBAT SPELLCASTING - Crowd Control (CLERIC)
// ======================================================

// Cast Hold Person
// Casts Hold Person to paralyze a humanoid target, rendering them immobile and unable to act.
// Lasts for 1 turn.
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    General(NearestEnemyOf(Myself),HUMANOID)
    HaveSpell(CLERIC_HOLD_PERSON)  // SPPR012.SPL (Hold Person)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,155)
        Spell(NearestEnemyOf(Myself),CLERIC_HOLD_PERSON)  // Cast Hold Person to incapacitate the enemy
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    General(NearestEnemyOf(Myself),HUMANOID)
    HaveSpell(CLERIC_COMMAND)  // SPPR012.SPL (Hold Person)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,156)
        Spell(NearestEnemyOf(Myself),CLERIC_COMMAND)  // Cast Hold Person to incapacitate the enemy
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    See([ENEMY])
    General(LastSeenBy(Myself),UNDEAD)
    !HasBounceEffects(NearestEnemyOf(Myself))
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    HaveSpell(LATHANDER_HOLD_UNDEAD)  // SPPR012.SPL (Hold Person)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,157)
        Spell(LastSeenBy(Myself),LATHANDER_HOLD_UNDEAD)  // Cast Hold Person to incapacitate the enemy
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_INSECT_PLAGUE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,158)
        Spell(NearestEnemyOf(Myself),CLERIC_INSECT_PLAGUE)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// CLERIC_SUMMON_INSECTS
IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(CLERIC_SUMMON_INSECTS)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,159)
        Spell(NearestEnemyOf(Myself),CLERIC_SUMMON_INSECTS)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// IN COMBAT SPELLCASTING - AOE OFFENSIVE (WIZARD)
// ======================================================
/* Comet for high damage and knockback */
IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(WIZARD_COMET)  // SPWI909.SPL (Comet)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,160)
        Spell(FarthestEnemyOf(Myself), WIZARD_COMET)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(WIZARD_DRAGONS_BREATH)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,161)
        Spell(FarthestEnemyOf(Myself),WIZARD_DRAGONS_BREATH)  // Cast Dragon's Breath
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(WIZARD_SKULL_TRAP)
    !Range(FarthestEnemyOf(Myself),13)  // Ensure the enemy is within medium range
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,162)
        Spell(FarthestEnemyOf(Myself),WIZARD_SKULL_TRAP)  // Cast Dragon's Breath
END

/* Ice Storm for enemies with more than 60 HP at medium range */
IF
    ActionListEmpty()
    HPGT(NearestEnemyOf(Myself),20)
    HaveSpell(WIZARD_ICE_STORM)  // SPWI409.SPL (Ice Storm)
    !Range(FarthestEnemyOf(Myself),10)  // Ensure the enemy is within medium range
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,163)
        Spell(FarthestEnemyOf(Myself),WIZARD_ICE_STORM)  // SPWI409.SPL (Ice Storm)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END
/* Fireball for enemies at a safe distance (30 search squares) */
IF
    ActionListEmpty()
    !GlobalTimerNotExpired("FIRE_ENEMIES","LOCALS")
    HaveSpell(WIZARD_FIREBALL)  // SPWI304.SPL (Fireball)
    !Range(FarthestEnemyOf(Myself),13)
    !HasBounceEffects(FarthestEnemyOf(Myself))
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,164)
        Spell(FarthestEnemyOf(Myself),WIZARD_FIREBALL)  // SPWI304.SPL (Fireball)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Burning Hands for nearby enemies with more than 20 HP */
IF
    ActionListEmpty()
    !GlobalTimerNotExpired("FIRE_ENEMIES","LOCALS")
    HPGT(NearestEnemyOf(Myself),20)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_BURNING_HANDS)  // SPWI103.SPL (Burning Hands)
    Range(NearestEnemyOf(Myself),4)  // Ensure the enemy is close enough
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,165)
        Spell(NearestEnemyOf(Myself),WIZARD_BURNING_HANDS)  // SPWI103.SPL (Burning Hands)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Color Spray for nearby enemies with more than 20 HP */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),10)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_COLOR_SPRAY)  // SPWI105.SPL (Color Spray)
    Range(NearestEnemyOf(Myself),4)  // Ensure the enemy is close enough
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,166)
        Spell(NearestEnemyOf(Myself),WIZARD_COLOR_SPRAY)  // SPWI105.SPL (Color Spray)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END
/* Cone of Cold for a close group of enemies */
IF
    ActionListEmpty()
    HaveSpell(WIZARD_CONE_OF_COLD)  // SPWI608.SPL (Cone of Cold)
    Range(NearestEnemyOf(Myself),4)  // Ensure the enemies are close enough
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,167)
        Spell(NearestEnemyOf(Myself),WIZARD_CONE_OF_COLD)  // SPWI608.SPL (Cone of Cold)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// IN COMBAT SPELLCASTING - OFFENSIVE Single Target (WIZARD)
// ======================================================


/* Magic Missile for enemies with more than 20 HP and no bounce effects */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_MAGIC_MISSILE)  // SPWI112.SPL (Magic Missile)
    HPGT(NearestEnemyOf(Myself),10)
    !HasBounceEffects(NearestEnemyOf(Myself))
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,168)
        Spell(NearestEnemyOf(Myself),WIZARD_MAGIC_MISSILE)  // SPWI112.SPL (Magic Missile)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Chromatic Orb for enemies with 10-20 HP, using level 1 spell */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_CHROMATIC_ORB)  // SPWI103.SPL (Chromatic Orb)
    HPGT(NearestEnemyOf(Myself),10)
    !StateCheck(NearestEnemyOf(Myself),STATE_HELPLESS)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,169)
        Spell(NearestEnemyOf(Myself),WIZARD_CHROMATIC_ORB)  // SPWI103.SPL (Chromatic Orb)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Melf's Acid Arrow for enemies with 20-40 HP */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_MELF_ACID_ARROW)  // SPWI205.SPL (Melf's Acid Arrow)
    OR(2)
        HPGT(NearestEnemyOf(Myself),20)
        GlobalTimerNotExpired("TROLL_ENEMIES","LOCALS")
    !HasBounceEffects(NearestEnemyOf(Myself))
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,170)
        Spell(NearestEnemyOf(Myself),WIZARD_MELF_ACID_ARROW)  // SPWI205.SPL (Melf's Acid Arrow)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Flame Arrow for enemies with 40-60 HP */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_FLAME_ARROW)  // SPWI304.SPL (Flame Arrow)
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,171)
        Spell(NearestEnemyOf(Myself),WIZARD_FLAME_ARROW)  // SPWI304.SPL (Flame Arrow)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Power Word Kill for enemies with low HP */
IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(WIZARD_POWER_WORD_KILL)  // SPWI910.SPL (Power Word Kill)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,172)
        Spell(NearestEnemyOf(Myself), WIZARD_POWER_WORD_KILL)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Finger of Death for enemies with more than 100 HP */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_FINGER_OF_DEATH)  // SPWI704.SPL (Finger of Death)
    HPGT(NearestEnemyOf(Myself),100)
    !HasBounceEffects(NearestEnemyOf(Myself))
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,173)
        Spell(NearestEnemyOf(Myself),WIZARD_FINGER_OF_DEATH)  // SPWI704.SPL (Finger of Death)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

/* Magic Missile as a fallback if all else fails */
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(WIZARD_MAGIC_MISSILE)  // SPWI112.SPL (Magic Missile)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,174)
        Spell(NearestEnemyOf(Myself),WIZARD_MAGIC_MISSILE)  // SPWI112.SPL (Magic Missile)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// IN COMBAT SPELLCASTING - OFFENSIVE SINGLE TARGET (CLERIC)
// ======================================================


// Cast Flame Strike
// Casts Flame Strike to deal fire damage in a vertical column around the target.
// Lasts for 1 turn.
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(CLERIC_FLAME_STRIKE)  // SPPR009.SPL (Flame Strike)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")

THEN
    RESPONSE #100
        DisplayStringHead(Myself,175)
        Spell(NearestEnemyOf(Myself),CLERIC_FLAME_STRIKE)  // Cast Flame Strike for vertical fire damage
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// Cast Flame Strike
// Casts Flame Strike to deal fire damage in a vertical column around the target.
// Lasts for 1 turn.
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HPGT(NearestEnemyOf(Myself),30)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(CLERIC_HOLY_SMITE)  // SPPR009.SPL (Flame Strike)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")

THEN
    RESPONSE #100
        DisplayStringHead(Myself,176)
        Spell(NearestEnemyOf(Myself),CLERIC_HOLY_SMITE)  // Cast Flame Strike for vertical fire damage
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)

END

// Cast Harm
// Casts Harm to deal a large amount of damage to the target, reducing their HP to 1.
// Lasts for 1 turn.
IF
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HPPercentLT(NearestEnemyOf(Myself),75)
    !HasBounceEffects(NearestEnemyOf(Myself))
    HaveSpell(CLERIC_HARM)  // SPPR010.SPL (Harm)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,177)
        Spell(NearestEnemyOf(Myself),CLERIC_HARM)  // Cast Harm to significantly reduce enemy's HP
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// SECTION: BUFFS (FIGHTER)
// ======================================================

IF
    ActionListEmpty()
    ActuallyInCombat()
    HaveSpell(WARRIOR_HARDINESS)
    !CheckSpellState(Myself,HARDINESS)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,178)
        Spell(Myself,WARRIOR_HARDINESS)  // Activate Hardiness for extra protection
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) 
        Continue()
END

IF
    ActionListEmpty()
    HaveSpell(WARRIOR_GREATER_WHIRLWIND)
    ActuallyInCombat()
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,179)
        Spell(Myself, WARRIOR_GREATER_WHIRLWIND)  // Perform Greater Whirlwind Attack
        AttackOneRound(NearestEnemyOf(Myself))
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND) 
        Continue()
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(MINSC_BERSERK)  // 3117 (MINSC_BERSERK)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")

    THEN
        RESPONSE #100
        DisplayStringHead(Myself,180)
        Spell(Myself,MINSC_BERSERK)  // Cast MINSC_BERSERK
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    See(NearestEnemyOf(Myself))
    HaveSpell(BERSERKER_RAGE)  // 3117 (MINSC_BERSERK)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,181)
        Spell(Myself,BERSERKER_RAGE)  // Cast MINSC_BERSERK
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(BARBARIAN_RAGE)  // 3117 (MINSC_BERSERK)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,182)
        Spell(Myself,BARBARIAN_RAGE)  // Cast MINSC_BERSERK
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(KENSAI_KIA)  // 3117 (MINSC_BERSERK)
    Range(NearestEnemyOf(Myself),30)
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,183)
        Spell(Myself,KENSAI_KIA)  // Cast MINSC_BERSERK
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// SECTION: PRE-COMBAT BUFFING (WIZARD)
// ======================================================
// Cast Spirit Armor
// Casts Spirit Armor to provide a magical shield that improves the wizard's armor class.
// Lasts for 1 hour per caster level.
IF
    ActionListEmpty()
    HaveSpell(WIZARD_CONTINGENCY)  // SPWI414.SPL (Spirit Armor)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,184)
        Spell(Myself,WIZARD_CONTINGENCY)  // Cast Spirit Armor for increased defense
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    HaveSpell(WIZARD_MINOR_SEQUENCER)  // SPWI414.SPL (Spirit Armor)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,185)
        Spell(Myself,WIZARD_MINOR_SEQUENCER)  // Cast Spirit Armor for increased defense
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END
// Cast Spirit Armor
// Casts Spirit Armor to provide a magical shield that improves the wizard's armor class.
// Lasts for 1 hour per caster level.
IF
    ActionListEmpty()
    HaveSpell(WIZARD_SPIRIT_ARMOR)  // SPWI414.SPL (Spirit Armor)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,186)
        Spell(Myself,WIZARD_SPIRIT_ARMOR)  // Cast Spirit Armor for increased defense
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Stoneskin
// Casts Stoneskin to grant the wizard protection from physical damage by turning their skin to stone.
// Lasts for 1 turn per caster level.
IF
    ActionListEmpty()
    HaveSpell(WIZARD_STONE_SKIN)  // SPWI408.SPL (Stoneskin)
    CheckStatLT(Myself,1,STONESKINS)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,187)
        Spell(Myself,WIZARD_STONE_SKIN)  // Cast Stoneskin for increased damage resistance
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Ghost Armor
// Casts Ghost Armor to provide an ethereal shield that grants a bonus to armor class.
// Lasts for 1 round per caster level.
IF
    ActionListEmpty()
    HaveSpell(WIZARD_GHOST_ARMOR)  // SPWI317.SPL (Ghost Armor)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)  
    CheckStatLT(Myself,1,DEAD_MAGIC)   
    CheckStatGT(Myself,2,ARMORCLASS)   
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,188)
        Spell(Myself,WIZARD_GHOST_ARMOR)  // Cast Ghost Armor for improved defense
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Armor
// Casts Armor to provide a magical armor that improves the wizard's armor class.
// Lasts for 1 hour per caster level.
IF
    ActionListEmpty()
    HaveSpell(WIZARD_ARMOR)  // SPWI102.SPL (Armor)
    CheckStatGT(Myself,6,ARMORCLASS)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,189)
        Spell(Myself,WIZARD_ARMOR)  // Cast Armor for increased protection before combat
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Protection from Normal Missiles
// Casts Protection from Normal Missiles to grant immunity to normal missile attacks.
// Lasts for 1 hour
IF
    ActionListEmpty()
    HaveSpell(WIZARD_PROTECTION_FROM_NORMAL_MISSILES)  // SPWI107.SPL (Protection from Normal Missiles)
    CheckStatLT(Myself,1,WIZARD_PROTECTION_FROM_NORMAL_MISSILES)  // Check if Protection from Normal Missiles is already active
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,190)
        Spell(Myself,WIZARD_PROTECTION_FROM_NORMAL_MISSILES)  // Cast Protection from Normal Missiles
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END
// Cast Shield
// Casts Shield to provide a magical shield that improves the wizard's armor class and grants a +4 bonus to AC.
// Lasts for 1 turn per caster level.
IF
    ActionListEmpty()
    HaveSpell(WIZARD_SHIELD)  // SPWI114.SPL (Shield)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,191)
        Spell(Myself,WIZARD_SHIELD)  // Cast Shield for added protection
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// Cast Resist Fear
// Casts Resist Fear to grant the wizard immunity to fear effects.
// Lasts for 1 turn per caster level.
IF
    !ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(WIZARD_RESIST_FEAR)  // SPWI103.SPL (Resist Fear)
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)    
    !GlobalTimerNotExpired("WIZARD_CAST","LOCALS")  // Ensure the spell is not recently cast
THEN
    RESPONSE #100
        DisplayStringHead(Myself,192)
        Spell(Myself,WIZARD_RESIST_FEAR)  // Cast Resist Fear for protection against fear
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END
// Cast Protection from Petrification
// Casts Protection from Petrification to grant immunity to petrification attacks.
// Lasts for 1 hour
IF
    ActionListEmpty()
    !ActuallyInCombat()
    HaveSpell(WIZARD_PROTECTION_FROM_PETRIFICATION)  // SPWI212.SPL (Protection from Petrification)
    CheckStatLT(Myself,1,WIZARD_PROTECTION_FROM_PETRIFICATION)  // Check if Protection from Petrification is already active
    CheckStatLT(Myself,50,SPELLFAILUREMAGE)
    CheckStatLT(Myself,1,DEAD_MAGIC)
    GlobalTimerExpired("WIZARD_CAST","LOCALS")
THEN
    RESPONSE #100
        DisplayStringHead(Myself,193)
        Spell(Myself,WIZARD_PROTECTION_FROM_PETRIFICATION)  // Cast Protection from Petrification
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// SECTION: SETTING TRAPS
// ======================================================

IF
    ActionListEmpty()
    Delay(30)
    HaveSpell(SET_SNARE_TRAP) 
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,194)
        Spell(Myself,SET_SNARE_TRAP) 
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    Delay(30)
    HaveSpell(SET_SPECIAL_SNARE_TRAP) 
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,195)
        Spell(Myself,SET_SPECIAL_SNARE_TRAP) 
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    Delay(30)
    HaveSpell(ROGUE_SET_SPIKE_TRAP) 
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,196)
        Spell(Myself,ROGUE_SET_SPIKE_TRAP) 
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    Delay(30)
    HaveSpell(ROGUE_SET_EXPLODING_TRAP)  
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,197)
        Spell(Myself,ROGUE_SET_EXPLODING_TRAP)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

IF
    ActionListEmpty()
    Delay(30)
    HaveSpell(ROGUE_SET_EXPLODING_TRAP)  
    !GlobalTimerNotExpired("CLERIC_CAST","LOCALS")
    THEN
        RESPONSE #100
        DisplayStringHead(Myself,198)
        Spell(Myself,ROGUE_SET_TIME_TRAP)
        SetGlobalTimer("CLERIC_CAST","LOCALS",ONE_ROUND)
END

// ======================================================
// SECTION: STEALTH AND THIEVING
// ======================================================

IF
    ActionListEmpty()
    !ActuallyInCombat()
    !StateCheck(Myself,STATE_INVISIBLE)
    !StateCheck(Myself,STATE_IMPROVEDINVISIBILITY)
    OR(3)
        Class(Myself,THIEF_ALL)
        Class(Myself,RANGER_ALL)
        Class(Myself,MONK)
    !Range(NearestEnemyOf(Myself),15)
    Delay(24)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,199)
        Hide()  // Hide in Shadows if not in combat and no enemies nearby
        Continue()
END

IF
    ActionListEmpty()
    !ActuallyInCombat()
    OR(2)
        Class(Myself,THIEF_ALL)
        Class(Myself,MONK)
    Delay(24)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,200)
        FindTraps()  // Detect Traps if hidden and not in combat
        Wait(6)
        Continue()
END


IF
    Class(Myself,BARD_ALL)
    !ModalState(DETECTTRAPS)
    !StateCheck(Myself,STATE_SILENCED)
    !ModalState(BATTLESONG)
    Delay(24)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,201)
        BattleSong()
        Wait(6)
        Continue()
END

// ======================================================
//  TURN UNDEAD (CLERIC)
// ======================================================

IF
    General([ENEMY],UNDEAD)
    LevelGT(Myself,12)
    CanTurn([Enemy],4)
    OR(2)
        Class(Myself,PALADIN_ALL)
        Class(Myself,CLERIC_ALL)
  THEN
    RESPONSE #100
        DisplayStringHead(Myself,202)
      Turn()
      Wait(12)
      Continue()
  END


// ======================================================
// SECTION: COMBAT ACTIONS - RANGED ATTACKS
// ======================================================


// Use special bow ability
IF
    ActuallyInCombat()
    ActionListEmpty()
    HaveSpell(ARCHER_CALL_SHOT) // Check if special ability is available
    See([ENEMY])
    !StateCheck(LastSeenBy(Myself),STATE_CHARMED)
    OR(3)
        WeaponEffectiveVs(LastSeenBy(Myself),MAINHAND)
        WeaponCanDamage(LastSeenBy(Myself),MAINHAND)
        !IsWeaponRanged(Myself)
    CanEquipRanged()
    !Range(LastSeenBy(Myself),4)
    CheckStatLT(LastSeenBy(Myself),100,RESISTMISSILE)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,203)
        EquipRanged()  // Equip ranged weapon
        Spell(Myself,ARCHER_CALL_SHOT) // Use special bow ability
        AttackOneRound(LastSeenBy(Myself))
        Continue()
END


IF
    ActionListEmpty()
    !ActuallyInCombat()
    See([ENEMY])
    !StateCheck(LastSeenBy(Myself),STATE_CHARMED)
    OR(3)
        WeaponEffectiveVs(LastSeenBy(Myself),MAINHAND)
        WeaponCanDamage(LastSeenBy(Myself),MAINHAND)
        !IsWeaponRanged(Myself)
    CanEquipRanged()
    !Range(LastSeenBy(Myself),4)  // If the enemy is within melee range (4 search squares)
    CheckStatLT(LastSeenBy(Myself),1,WIZARD_PROTECTION_FROM_NORMAL_MISSILES)  // Check if Protection from Normal Missiles is already active
THEN
    RESPONSE #100
        DisplayStringHead(Myself,204)
        EquipRanged()  // Equip ranged weapon
        AttackOneRound(LastSeenBy(Myself))
        Continue()
END


// ======================================================
// SECTION: COMBAT ACTIONS - MELEE ATTACKS
// ======================================================

IF
    ActionListEmpty()
    ActuallyInCombat()
    WeaponEffectiveVs(LastSeenBy(Myself),MAINHAND)
    WeaponCanDamage(LastSeenBy(Myself),MAINHAND)
    !StateCheck(LastSeenBy(Myself),STATE_CHARMED)
    WeaponEffectiveVs(LastSeenBy(Myself),MAINHAND)
    WeaponCanDamage(LastSeenBy(Myself),MAINHAND)
    Range(NearestEnemyOf(Myself),4)  // If the enemy is within melee range (4 search squares)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,205)
        EquipMostDamagingMelee()  // Equip the most damaging melee weapon
        AttackOneRound(NearestEnemyOf(Myself))
        Continue()
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    See([ENEMY])
    !StateCheck(LastSeenBy(Myself),STATE_CHARMED)
    WeaponEffectiveVs(LastSeenBy(Myself),MAINHAND)
    WeaponCanDamage(LastSeenBy(Myself),MAINHAND)
    !GlobalTimerNotExpired("USE_RANGED","LOCALS")
    OR(2)
        Class(Myself,FIGHTER_ALL)
        Class(Myself,PALADIN_ALL)
    !Class(Myself,CLERIC_ALL)
    !Class(Myself,MAGE_ALL)
    !Class(Myself,DRUID_ALL)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,206)
        EquipMostDamagingMelee()  // Equip the most damaging melee weapon
        AttackOneRound(NearestEnemyOf(Myself))
        Continue()
END

// ======================================================
// SECTION: RETREAT CONDITION
// ======================================================


IF
    See(NearestEnemyOf(Myself))
    Range(LastSeenBy(Myself),15)
    AttackedBy([ENEMY],DEFAULT)
    HPPercentLT(Myself,100)
    HaveSpell(WIZARD_SHADOW_DOOR)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,207)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
        FaceObject(LastSeenBy(Myself))
        Spell(Myself,WIZARD_SHADOW_DOOR)  // SPWI505.SPL (Shadow Door)
        RunAwayFrom(NearestEnemyOf(Myself),15)
END

IF
    See(NearestEnemyOf(Myself))
    Range(LastSeenBy(Myself),15)
    AttackedBy([ENEMY],DEFAULT)
    HPPercentLT(Myself,100)
    HaveSpell(WIZARD_MISLEAD)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,208)
        SetGlobalTimer("WIZARD_CAST","LOCALS",ONE_ROUND)
        FaceObject(LastSeenBy(Myself))
        Spell(Myself,WIZARD_MISLEAD)  // SPWI505.SPL (Shadow Door)
        RunAwayFrom(NearestEnemyOf(Myself),15)

END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HPPercentLT(Myself,37)
    !StateCheck(Myself,STATE_INVISIBLE)
    HaveSpell(WIZARD_INVISIBILITY)  // SPWI206.SPL (Invisibility)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,209)
        Spell(Myself,WIZARD_INVISIBILITY)  // Turn invisible to retreat
        RunAwayFrom(NearestEnemyOf(Myself),15)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    Delay(18)
    OR(4)
        Class(Myself,THIEF_ALL)
        Class(Myself,RANGER_ALL)
        Class(Myself,MONK)
        Class(Myself,MAGE_ALL)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,210)
        RunAwayFrom(NearestEnemyOf(Myself),10)
END

IF
    ActionListEmpty()
    ActuallyInCombat()
    HPPercentLT(Myself,37)
    OR(3)
        Class(Myself,THIEF_ALL)
        Class(Myself,RANGER_ALL)
        Class(Myself,MONK)
    !StateCheck(Myself,STATE_INVISIBLE)
THEN
    RESPONSE #100
        DisplayStringHead(Myself,211)
        RunAwayFrom(NearestEnemyOf(Myself),10)
        Hide()
>>>>>>> 9502144 (Adding innate spells using SpellRES)
END